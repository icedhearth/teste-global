<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário de Inscrição Global Entry</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.16/jspdf.autotable.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            color: #333;
            box-sizing: border-box;
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
        }

        h1, h3 {
            text-align: center;
            color: #0056b3;
            margin-bottom: 20px;
        }

        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        .form-section h3 {
            margin-top: 0;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="date"],
        .form-group input[type="month"], /* Adicionado para campos de mês/ano */
        .form-group input[type="number"],
        .form-group select,
        .form-group textarea {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input[type="text"]:focus,
        .form-group input[type="email"]:focus,
        .form-group input[type="date"]:focus,
        .form-group input[type="month"]:focus, /* Adicionado para campos de mês/ano */
        .form-group input[type="number"]:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #007bff;
            outline: none;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .radio-group label,
        .checkbox-group label {
            display: inline-block;
            margin-right: 15px;
            font-weight: normal;
        }

        .radio-group input[type="radio"],
        .checkbox-group input[type="checkbox"] {
            margin-right: 5px;
        }

        .button-group {
            text-align: center;
            margin-top: 30px;
        }

        .button-group button {
            background-color: #007bff;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease;
            margin: 0 10px;
        }

        .button-group button:hover {
            background-color: #0056b3;
        }

        .declaration-text {
            font-size: 0.9em;
            color: #666;
            margin-top: 20px;
            text-align: justify;
        }

        /* Estilos para seções condicionais (display: none por padrão) */
        .conditional-section {
            display: none;
            margin-top: 15px;
            padding: 15px;
            border: 1px dashed #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 20px;
            }

            .form-group input[type="text"],
            .form-group input[type="email"],
            .form-group input[type="date"],
            .form-group input[type="month"],
            .form-group input[type="number"],
            .form-group select,
            .form-group textarea {
                width: calc(100% - 20px); /* Adjust for padding on smaller screens */
            }

            .button-group button {
                width: 100%;
                margin-bottom: 10px;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.8em;
            }

            h3 {
                font-size: 1.2em;
            }

            .form-section {
                padding: 15px;
            }

            .form-group label {
                font-size: 0.95em;
            }

            .form-group input, .form-group select, .form-group textarea {
                font-size: 0.9em;
            }

            .radio-group label,
            .checkbox-group label {
                display: block;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Formulário de Inscrição Global Entry</h1>
        <p style="text-align: center;">Preencha o formulário com seus dados para a aplicação do Global Entry.</p>

        <form id="globalEntryForm">
            <div class="form-section">
                <h3>1. Dados Pessoais</h3>
                <div class="form-group">
                    <label for="fullName">Nome Completo (como no passaporte):</label>
                    <input type="text" id="fullName" name="fullName">
                </div>
                <div class="form-group">
                    <label for="dob">Data de Nascimento:</label>
                    <input type="date" id="dob" name="dob">
                </div>
                <div class="form-group">
                    <label for="gender">Gênero:</label>
                    <select id="gender" name="gender">
                        <option value="">Selecione</option>
                        <option value="Masculino">Masculino</option>
                        <option value="Feminino">Feminino</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="nationality">Nacionalidade Atual:</label>
                    <input type="text" id="nationality" name="nationality">
                </div>
                <div class="form-group">
                    <label for="otherNationalities">Outras Nacionalidades (se houver):</label>
                    <input type="text" id="otherNationalities" name="otherNationalities">
                </div>
                <div class="form-group">
                    <label for="countryOfBirth">País de Nascimento:</label>
                    <input type="text" id="countryOfBirth" name="countryOfBirth">
                </div>
                <div class="form-group">
                    <label for="cityOfBirth">Cidade de Nascimento:</label>
                    <input type="text" id="cityOfBirth" name="cityOfBirth">
                </div>
                <div class="form-group">
                    <label for="maritalStatus">Estado Civil:</label>
                    <select id="maritalStatus" name="maritalStatus">
                        <option value="">Selecione</option>
                        <option value="Solteiro">Solteiro</option>
                        <option value="Casado">Casado</option>
                        <option value="Divorciado">Divorciado</option>
                        <option value="Viúvo">Viúvo</option>
                        <option value="União Estável">União Estável</option>
                    </select>
                </div>

                <div id="spouseInfo" class="conditional-section">
                    <h4>Dados do Cônjuge</h4>
                    <div class="form-group">
                        <label for="spouseFullName">Nome Completo do Cônjuge:</label>
                        <input type="text" id="spouseFullName" name="spouseFullName">
                    </div>
                    <div class="form-group">
                        <label for="spouseDob">Data de Nascimento do Cônjuge:</label>
                        <input type="date" id="spouseDob" name="spouseDob">
                    </div>
                    <div class="form-group">
                        <label for="spouseCountryOfBirth">País de Nascimento do Cônjuge:</label>
                        <input type="text" id="spouseCountryOfBirth" name="spouseCountryOfBirth">
                    </div>
                    <div id="spouseDeathInfo" class="conditional-section">
                        <div class="form-group">
                            <label for="spouseDod">Data de Falecimento do Cônjuge:</label>
                            <input type="date" id="spouseDod" name="spouseDod">
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>2. Dados do Passaporte</h3>
                <div class="form-group">
                    <label for="passportNumber">Número do Passaporte:</label>
                    <input type="text" id="passportNumber" name="passportNumber">
                </div>
                <div class="form-group">
                    <label for="issueDate">Data de Emissão:</label>
                    <input type="date" id="issueDate" name="issueDate">
                </div>
                <div class="form-group">
                    <label for="expiryDate">Data de Validade:</label>
                    <input type="date" id="expiryDate" name="expiryDate">
                </div>
                <div class="form-group">
                    <label for="issuingCountry">País Emissor:</label>
                    <input type="text" id="issuingCountry" name="issuingCountry">
                </div>
            </div>

            <div class="form-section">
                <h3>3. Endereço Atual e Contato</h3>
                <div class="form-group">
                    <label for="currentAddress">Endereço (Rua, Número, Complemento):</label>
                    <input type="text" id="currentAddress" name="currentAddress">
                </div>
                <div class="form-group">
                    <label for="currentCity">Cidade:</label>
                    <input type="text" id="currentCity" name="currentCity">
                </div>
                <div class="form-group">
                    <label for="currentState">Estado/Província:</label>
                    <input type="text" id="currentState" name="currentState">
                </div>
                <div class="form-group">
                    <label for="currentZipCode">CEP/Código Postal:</label>
                    <input type="text" id="currentZipCode" name="currentZipCode">
                </div>
                <div class="form-group">
                    <label for="currentCountry">País:</label>
                    <input type="text" id="currentCountry" name="currentCountry">
                </div>
                <div class="form-group">
                    <label for="phone">Telefone:</label>
                    <input type="text" id="phone" name="phone" placeholder="(XX) XXXXX-XXXX">
                </div>
                <div class="form-group">
                    <label for="email">E-mail:</label>
                    <input type="email" id="email" name="email">
                </div>
            </div>

            <div class="form-section">
                <h3>4. Informações Familiares</h3>
                <div class="form-group">
                    <label for="parentsAlive">Seus pais estão vivos?</label>
                    <select id="parentsAlive" name="parentsAlive">
                        <option value="">Selecione</option>
                        <option value="Sim">Sim</option>
                        <option value="Não">Não</option>
                    </select>
                </div>
                <div id="parentsInfo" class="conditional-section">
                    <div class="form-group">
                        <label for="fatherFullName">Nome Completo do Pai:</label>
                        <input type="text" id="fatherFullName" name="fatherFullName">
                    </div>
                    <div class="form-group">
                        <label for="fatherDob">Data de Nascimento do Pai:</label>
                        <input type="date" id="fatherDob" name="fatherDob">
                    </div>
                    <div class="form-group">
                        <label for="motherFullName">Nome Completo da Mãe:</label>
                        <input type="text" id="motherFullName" name="motherFullName">
                    </div>
                    <div class="form-group">
                        <label for="motherDob">Data de Nascimento da Mãe:</label>
                        <input type="date" id="motherDob" name="motherDob">
                    </div>
                    <div class="form-group">
                        <label for="parentsInUS">Seus pais estão nos EUA?</label>
                        <select id="parentsInUS" name="parentsInUS">
                            <option value="">Selecione</option>
                            <option value="Sim">Sim</option>
                            <option value="Não">Não</option>
                        </select>
                    </div>
                    <div id="parentsInUSDetails" class="conditional-section">
                        <div class="form-group">
                            <label for="parentsInUSExplanation">Explique a situação dos seus pais nos EUA:</label>
                            <textarea id="parentsInUSExplanation" name="parentsInUSExplanation" rows="2"></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="knownInUS">Você tem conhecidos nos EUA?</label>
                    <select id="knownInUS" name="knownInUS">
                        <option value="">Selecione</option>
                        <option value="Sim">Sim</option>
                        <option value="Não">Não</option>
                    </select>
                </div>
                <div id="knownInUSInfo" class="conditional-section">
                    <h4>Dados do Conhecido nos EUA</h4>
                    <div class="form-group">
                        <label for="knownName">Nome Completo do Conhecido:</label>
                        <input type="text" id="knownName" name="knownName">
                    </div>
                    <div class="form-group">
                        <label for="knownPhone">Telefone do Conhecido:</label>
                        <input type="text" id="knownPhone" name="knownPhone">
                    </div>
                    <div class="form-group">
                        <label for="knownEmail">E-mail do Conhecido:</label>
                        <input type="email" id="knownEmail" name="knownEmail">
                    </div>
                    <div class="form-group">
                        <label for="knownRelationship">Vínculo com o Solicitante:</label>
                        <input type="text" id="knownRelationship" name="knownRelationship" placeholder="Ex: amigo, parente, colega">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>5. Histórico de Endereços (Últimos 5 anos)</h3>
                <p>Liste todos os endereços onde você residiu nos últimos 5 anos. Comece pelo mais recente.</p>
                <div id="addressHistoryContainer">
                    <div class="address-entry">
                        <div class="form-group">
                            <label>Endereço:</label>
                            <input type="text" name="pastAddress[]" placeholder="Rua, Número, Complemento">
                        </div>
                        <div class="form-group">
                            <label>Cidade:</label>
                            <input type="text" name="pastCity[]">
                        </div>
                        <div class="form-group">
                            <label>Estado/Província:</label>
                            <input type="text" name="pastState[]">
                        </div>
                        <div class="form-group">
                            <label>País:</label>
                            <input type="text" name="pastCountry[]">
                        </div>
                        <div class="form-group">
                            <label>De (MM/AAAA):</label>
                            <input type="month" name="pastAddressFrom[]">
                        </div>
                        <div class="form-group">
                            <label>Até (MM/AAAA):</label>
                            <input type="month" name="pastAddressTo[]">
                        </div>
                    </div>
                </div>
                <button type="button" onclick="addAddressEntry()" style="background-color: #28a745; margin-top: 10px;">Adicionar Endereço</button>
            </div>

            <div class="form-section">
                <h3>6. Histórico de Emprego (Últimos 5 anos)</h3>
                <p>Liste seu histórico de emprego nos últimos 5 anos. Comece pelo mais recente.</p>
                <div id="employmentHistoryContainer">
                    <div class="employment-entry">
                        <div class="form-group">
                            <label>Empregador:</label>
                            <input type="text" name="employerName[]">
                        </div>
                        <div class="form-group">
                            <label>Cargo:</label>
                            <input type="text" name="occupation[]">
                        </div>
                        <div class="form-group">
                            <label>Endereço do Empregador:</label>
                            <input type="text" name="employerAddress[]" placeholder="Rua, Número, Cidade, País">
                        </div>
                        <div class="form-group">
                            <label>De (MM/AAAA):</label>
                            <input type="month" name="employmentFrom[]">
                        </div>
                        <div class="form-group">
                            <label>Até (MM/AAAA):</label>
                            <input type="month" name="employmentTo[]">
                        </div>
                    </div>
                </div>
                <button type="button" onclick="addEmploymentEntry()" style="background-color: #28a745; margin-top: 10px;">Adicionar Emprego</button>
            </div>

            <div class="form-section">
                <h3>7. Histórico de Viagens Internacionais (Últimos 5 anos)</h3>
                <p>Liste todos os países que você visitou nos últimos 5 anos, exceto o seu país de residência atual.</p>
                <div id="travelHistoryContainer">
                    <div class="travel-entry">
                        <div class="form-group">
                            <label>País Visitado:</label>
                            <input type="text" name="countryVisited[]">
                        </div>
                        <div class="form-group">
                            <label>Data de Entrada (MM/AAAA):</label>
                            <input type="month" name="entryDate[]">
                        </div>
                        <div class="form-group">
                            <label>Data de Saída (MM/AAAA):</label>
                            <input type="month" name="exitDate[]">
                        </div>
                        <div class="form-group">
                            <label>Propósito da Viagem:</label>
                            <textarea name="travelPurpose[]" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <button type="button" onclick="addTravelEntry()" style="background-color: #28a745; margin-top: 10px;">Adicionar Viagem</button>
            </div>

            <div class="form-section">
                <h3>8. Perguntas de Elegibilidade e Histórico</h3>
                <div class="form-group radio-group">
                    <label>a. Você já foi condenado(a) por qualquer crime (incluindo DUI/DWI), tem alguma acusação criminal pendente, ou possui mandados de prisão em aberto em qualquer país?</label>
                    <input type="radio" id="crimeYes" name="criminalRecord" value="Sim"> <label for="crimeYes">Sim</label>
                    <input type="radio" id="crimeNo" name="criminalRecord" value="Não" checked> <label for="crimeNo">Não</label>
                    <div class="form-group" id="crimeDetails" style="display: none; margin-top: 10px;">
                        <label for="crimeExplanation">Explique:</label>
                        <textarea id="crimeExplanation" name="crimeExplanation" rows="3"></textarea>
                    </div>
                </div>

                <div class="form-group radio-group">
                    <label>b. Você já foi considerado(a) culpado(a) de violação de quaisquer regulamentos ou leis alfandegárias, de imigração ou agrícolas em qualquer país?</label>
                    <input type="radio" id="violationYes" name="violationRecord" value="Sim"> <label for="violationYes">Sim</label>
                    <input type="radio" id="violationNo" name="violationRecord" value="Não" checked> <label for="violationNo">Não</label>
                    <div class="form-group" id="violationDetails" style="display: none; margin-top: 10px;">
                        <label for="violationExplanation">Explique:</label>
                        <textarea id="violationExplanation" name="violationExplanation" rows="3"></textarea>
                    </div>
                </div>

                <div class="form-group radio-group">
                    <label>c. Você é objeto de uma investigação em andamento por qualquer agência federal, estadual ou local de aplicação da lei?</label>
                    <input type="radio" id="investigationYes" name="investigationStatus" value="Sim"> <label for="investigationYes">Sim</label>
                    <input type="radio" id="investigationNo" name="investigationStatus" value="Não" checked> <label for="investigationNo">Não</label>
                    <div class="form-group" id="investigationDetails" style="display: none; margin-top: 10px;">
                        <label for="investigationExplanation">Explique:</label>
                        <textarea id="investigationExplanation" name="investigationExplanation" rows="3"></textarea>
                    </div>
                </div>

                <div class="form-group radio-group">
                    <label>d. Você já forneceu informações falsas ou incompletas em qualquer formulário de inscrição ou processo de imigração para os Estados Unidos ou qualquer outro país?</label>
                    <input type="radio" id="falseInfoYes" name="falseInformation" value="Sim"> <label for="falseInfoYes">Sim</label>
                    <input type="radio" id="falseInfoNo" name="falseInformation" value="Não" checked> <label for="falseInfoNo">Não</label>
                    <div class="form-group" id="falseInfoDetails" style="display: none; margin-top: 10px;">
                        <label for="falseInfoExplanation">Explique:</label>
                        <textarea id="falseInfoExplanation" name="falseInfoExplanation" rows="3"></textarea>
                    </div>
                </div>
            </div>

            <div class="form-section declaration-section">
                <h3>9. Declaração e Autorização</h3>
                <p>Eu, <input type="text" id="declaracaoNome" name="declaracaoNome" placeholder="Seu Nome Completo">, declaro, sob as penas da lei, que li e compreendi integralmente todas as questões contidas nesta solicitação de visto e afirmo que as respostas por mim fornecidas são verdadeiras, completas e corretas, conforme o meu melhor conhecimento e convicção.</p>

                <p><strong>Declaro estar ciente de que:</strong></p>
                <ol>
                    <li>Qualquer declaração falsa, incompleta ou enganosa poderá resultar na recusa permanente do visto ou na negativa de admissão nos Estados Unidos, conforme disposto na legislação aplicável.</li>
                    <li>Todas as informações prestadas nesta solicitação constituem declarações juramentadas, realizadas sob pena de perjúrio, nos termos do disposto no <em>28 U.S.C. § 1746</em>.</li>
                    <li>Informações adicionais poderão ser requisitadas pelas autoridades competentes após a análise desta solicitação, sendo minha responsabilidade fornecê-las tempestivamente.</li>
                    <li>As informações contidas nesta solicitação poderão ser compartilhadas com outras agências governamentais dos Estados Unidos, que possuem autoridade para utilizá-las para fins de aplicação da lei ou para propósitos imigratórios, conforme permitido pela legislação vigente.</li>
                    <li>A fotografia fornecida com esta solicitação poderá ser utilizada pelas autoridades americanas para fins de verificação de identidade, empregabilidade ou outros objetivos legais previstos na legislação dos Estados Unidos.</li>
                </ol>

                <p><strong>Declaro ainda:</strong></p>
                <ol start="6">
                    <li>Que sou exclusivamente responsável pela autenticidade e exatidão dos documentos apresentados e das informações prestadas nesta solicitação.</li>
                    <li>Que tenho pleno conhecimento de que a concessão ou negativa do visto é prerrogativa exclusiva da Autoridade Consular Americana, não cabendo a terceiros qualquer ingerência sobre tal decisão.</li>
                    <li>Que estou ciente de que, em processos de renovação de visto, entrevistas presenciais poderão ser exigidas a critério exclusivo da Autoridade Consular Americana.</li>
                    <li>Que reconheço que o serviço contratado constitui assessoria relacionada ao processo de preenchimento de documentação, agendamento de biometria e entrevista, não abrangendo serviços de entrega ou retirada de documentos no Centro de Atendimento ao Solicitante de Visto (CASV), sendo necessária a contratação de um agente colaborador, caso eu deseje tais serviços adicionais.</li>
                    <li>Que a aposição de minha assinatura eletrônica neste documento possui validade jurídica, conforme a legislação aplicável, e representa meu reconhecimento expresso dos serviços contratados.</li>
                </ol>

                <p><strong>Autorização:</strong></p>
                <p>Declaro, por fim, ter revisado e conferido todos os dados por mim apresentados, autorizando expressamente a empresa **Objetivo Turismo Ltda.**, contratada diretamente por mim ou por intermédio de minha agência, a proceder com o envio eletrônico do Formulário DS-160 ao Consulado Americano, bem como a realizar o pagamento das taxas e o agendamento necessários à tramitação do meu pedido de visto.</p>

                <div class="form-group">
                    <label for="declaracaoLocal">Local:</label>
                    <input type="text" id="declaracaoLocal" name="declaracaoLocal">
                </div>
                <div class="form-group">
                    <label for="declaracaoData">Data:</label>
                    <input type="date" id="declaracaoData" name="declaracaoData">
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="aceiteDeclaracao" name="aceiteDeclaracao">
                    <label for="aceiteDeclaracao">Concordo com os termos desta declaração</label>
                </div>
            </div>

            <div class="button-group">
                <button type="button" onclick="generateGlobalEntryPDF()">Gerar PDF</button>
                <button type="reset">Limpar Formulário</button>
            </div>
        </form>
    </div>

    <script type="module">
        // Importa as funções necessárias do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-storage.js";

        // Configuração do Firebase com suas credenciais (A MESMA API KEY FORNECIDA)
        const firebaseConfig = {
            apiKey: "AIzaSyAkBV0rHEghBOHl2mDOs6rMDHkUgYMxFr0", // Sua API Key real
            authDomain: "visaformulariostorage.firebaseapp.com",
            projectId: "visaformulariostorage",
            storageBucket: "visaformulariostorage.firebasestorage.app",
            messagingSenderId: "720170394408",
            appId: "1:720170394408:web:b1c294c39c489388f6261d",
            measurementId: "G-ZFCV4JEEFT"
        };

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);

        // --- Funções Auxiliares ---
        function formatDateBr(dateStr) {
            if (!dateStr) return 'Não informado';
            try {
                const [year, month, day] = dateStr.split('-');
                const date = new Date(year, month - 1, day);
                if (isNaN(date.getTime())) {
                    return 'Data inválida';
                }
                return date.toLocaleDateString('pt-BR', { timeZone: 'America/Sao_Paulo' });
            } catch (e) {
                return 'Erro ao formatar data';
            }
        }

        // Função para adicionar campos de histórico de endereço
        window.addAddressEntry = function() { // Exposto globalmente para o onclick
            const container = document.getElementById('addressHistoryContainer');
            const newEntry = document.createElement('div');
            newEntry.classList.add('address-entry');
            newEntry.innerHTML = `
                <div class="form-group">
                    <label>Endereço:</label>
                    <input type="text" name="pastAddress[]" placeholder="Rua, Número, Complemento">
                </div>
                <div class="form-group">
                    <label>Cidade:</label>
                    <input type="text" name="pastCity[]">
                </div>
                <div class="form-group">
                    <label>Estado/Província:</label>
                    <input type="text" name="pastState[]">
                </div>
                <div class="form-group">
                    <label>País:</label>
                    <input type="text" name="pastCountry[]">
                </div>
                <div class="form-group">
                    <label>De (MM/AAAA):</label>
                    <input type="month" name="pastAddressFrom[]">
                </div>
                <div class="form-group">
                    <label>Até (MM/AAAA):</label>
                    <input type="month" name="pastAddressTo[]">
                </div>
                <button type="button" onclick="this.parentNode.remove()" style="background-color: #dc3545; margin-top: 5px;">Remover</button>
                <hr style="margin: 15px 0;">
            `;
            container.appendChild(newEntry);
        }

        // Função para adicionar campos de histórico de emprego
        window.addEmploymentEntry = function() { // Exposto globalmente para o onclick
            const container = document.getElementById('employmentHistoryContainer');
            const newEntry = document.createElement('div');
            newEntry.classList.add('employment-entry');
            newEntry.innerHTML = `
                <div class="form-group">
                    <label>Empregador:</label>
                    <input type="text" name="employerName[]">
                </div>
                <div class="form-group">
                    <label>Cargo:</label>
                    <input type="text" name="occupation[]">
                </div>
                <div class="form-group">
                    <label>Endereço do Empregador:</label>
                    <input type="text" name="employerAddress[]" placeholder="Rua, Número, Cidade, País">
                </div>
                <div class="form-group">
                    <label>De (MM/AAAA):</label>
                    <input type="month" name="employmentFrom[]">
                </div>
                <div class="form-group">
                    <label>Até (MM/AAAA):</label>
                    <input type="month" name="employmentTo[]">
                </div>
                <button type="button" onclick="this.parentNode.remove()" style="background-color: #dc3545; margin-top: 5px;">Remover</button>
                <hr style="margin: 15px 0;">
            `;
            container.appendChild(newEntry);
        }

        // Função para adicionar campos de histórico de viagens
        window.addTravelEntry = function() { // Exposto globalmente para o onclick
            const container = document.getElementById('travelHistoryContainer');
            const newEntry = document.createElement('div');
            newEntry.classList.add('travel-entry');
            newEntry.innerHTML = `
                <div class="form-group">
                    <label>País Visitado:</label>
                    <input type="text" name="countryVisited[]">
                </div>
                <div class="form-group">
                    <label>Data de Entrada (MM/AAAA):</label>
                    <input type="month" name="entryDate[]">
                </div>
                <div class="form-group">
                    <label>Data de Saída (MM/AAAA):</label>
                    <input type="month" name="exitDate[]">
                </div>
                <div class="form-group">
                    <label>Propósito da Viagem:</label>
                    <textarea name="travelPurpose[]" rows="2"></textarea>
                </div>
                <button type="button" onclick="this.parentNode.remove()" style="background-color: #dc3545; margin-top: 5px;">Remover</button>
                <hr style="margin: 15px 0;">
            `;
            container.appendChild(newEntry);
        }

        // Funções de toggle para campos condicionais (baseadas na lógica do DS-160)
        function toggleSpouseInfo() {
            const maritalStatus = document.getElementById('maritalStatus');
            const spouseInfo = document.getElementById('spouseInfo');
            const spouseDeathInfo = document.getElementById('spouseDeathInfo');

            if (['Casado', 'Divorciado', 'Viúvo', 'União Estável'].includes(maritalStatus.value)) {
                spouseInfo.style.display = 'block';
                if (maritalStatus.value === 'Viúvo') {
                    spouseDeathInfo.style.display = 'block';
                } else {
                    spouseDeathInfo.style.display = 'none';
                    spouseDeathInfo.querySelectorAll('input, textarea, select').forEach(input => input.value = '');
                }
            } else {
                spouseInfo.style.display = 'none';
                spouseInfo.querySelectorAll('input, textarea, select').forEach(input => input.value = '');
                spouseDeathInfo.style.display = 'none';
                spouseDeathInfo.querySelectorAll('input, textarea, select').forEach(input => input.value = '');
            }
        }

        function toggleParentsInfo() {
            const parentsAlive = document.getElementById('parentsAlive');
            const parentsInfo = document.getElementById('parentsInfo');
            if (parentsAlive.value === 'Sim') {
                parentsInfo.style.display = 'block';
                toggleParentsInUSDetails(); // Reavalia a sub-seção
            } else {
                parentsInfo.style.display = 'none';
                parentsInfo.querySelectorAll('input, textarea, select').forEach(input => input.value = '');
                document.getElementById('parentsInUSDetails').style.display = 'none';
                document.getElementById('parentsInUSDetails').querySelectorAll('input, textarea, select').forEach(input => input.value = '');
            }
        }

        function toggleParentsInUSDetails() {
            const parentsInUS = document.getElementById('parentsInUS');
            const parentsInUSDetails = document.getElementById('parentsInUSDetails');
            if (parentsInUS.value === 'Sim') {
                parentsInUSDetails.style.display = 'block';
            } else {
                parentsInUSDetails.style.display = 'none';
                parentsInUSDetails.querySelectorAll('input, textarea, select').forEach(input => input.value = '');
            }
        }

        function toggleKnownInUSInfo() {
            const knownInUS = document.getElementById('knownInUS');
            const knownInUSInfo = document.getElementById('knownInUSInfo');
            if (knownInUS.value === 'Sim') {
                knownInUSInfo.style.display = 'block';
            } else {
                knownInUSInfo.style.display = 'none';
                knownInUSInfo.querySelectorAll('input, textarea, select').forEach(input => input.value = '');
            }
        }

        // Lógica para mostrar/esconder campos de explicação para as perguntas de elegibilidade
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('maritalStatus').addEventListener('change', toggleSpouseInfo);
            document.getElementById('parentsAlive').addEventListener('change', toggleParentsInfo);
            document.getElementById('parentsInUS').addEventListener('change', toggleParentsInUSDetails);
            document.getElementById('knownInUS').addEventListener('change', toggleKnownInUSInfo);

            document.querySelectorAll('input[name="criminalRecord"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    document.getElementById('crimeDetails').style.display = event.target.value === 'Sim' ? 'block' : 'none';
                });
            });
            document.querySelectorAll('input[name="violationRecord"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    document.getElementById('violationDetails').style.display = event.target.value === 'Sim' ? 'block' : 'none';
                });
            });
            document.querySelectorAll('input[name="investigationStatus"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    document.getElementById('investigationDetails').style.display = event.target.value === 'Sim' ? 'block' : 'none';
                });
            });
            document.querySelectorAll('input[name="falseInformation"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    document.getElementById('falseInfoDetails').style.display = event.target.value === 'Sim' ? 'block' : 'none';
                });
            });

            // Chamadas iniciais para definir o estado correto no carregamento da página
            toggleSpouseInfo();
            toggleParentsInfo();
            toggleParentsInUSDetails();
            toggleKnownInUSInfo();

            // Inicializar estado dos campos de elegibilidade
            document.getElementById('crimeNo').checked = true; // Define 'Não' como padrão
            document.getElementById('violationNo').checked = true;
            document.getElementById('investigationNo').checked = true;
            document.getElementById('falseInfoNo').checked = true;

            document.getElementById('crimeDetails').style.display = 'none';
            document.getElementById('violationDetails').style.display = 'none';
            document.getElementById('investigationDetails').style.display = 'none';
            document.getElementById('falseInfoDetails').style.display = 'none';
        });

        // Função para adicionar texto justificado com formatação (para o PDF)
        function addJustifiedText(doc, text, x, y, maxWidth, lineHeight) {
            const words = text.split(' ');
            let line = '';
            let currentY = y;
            
            // Variáveis para controlar estados de formatação
            let isBold = false;
            let isItalic = false;

            for (let i = 0; i < words.length; i++) {
                let word = words[i];
                let originalWord = word; // Guarda a palavra original para verificar marcadores

                // Atualiza o estado da formatação se encontrar marcadores
                if (originalWord.includes('**')) {
                    isBold = !isBold;
                    word = word.replace(/\*\*/g, '');
                }
                if (originalWord.includes('_')) { // Usando _ para itálico
                    isItalic = !isItalic;
                    word = word.replace(/_/g, '');
                }

                // Define a fonte para a palavra atual
                let fontStyle = 'normal';
                if (isBold && isItalic) fontStyle = 'bolditalic';
                else if (isBold) fontStyle = 'bold';
                else if (isItalic) fontStyle = 'italic';
                
                doc.setFont(doc.getFont().fontName, fontStyle);
                
                const testLine = line + (line ? ' ' : '') + word;
                const testWidth = doc.getTextWidth(testLine);

                if (testWidth > maxWidth && i > 0) {
                    doc.text(line, x, currentY, { align: 'justify' });
                    line = word;
                    currentY += lineHeight;
                } else {
                    line = testLine;
                }
            }
            if (line) {
                doc.text(line, x, currentY, { align: 'justify' });
            }
            return currentY + lineHeight; // Return next Y position
        }

        window.generateGlobalEntryPDF = async function() { // Exposto globalmente para o onclick
            const doc = new jsPDF();
            let y = 20;
            const margin = 20;
            const lineHeight = 7;
            const form = document.getElementById('globalEntryForm');
            const fixedWhatsAppNumber = '5561999998165'; // Seu número de WhatsApp fixo

            doc.setFontSize(18);
            doc.setTextColor(40, 40, 40);
            doc.text("Formulário de Inscrição Global Entry", doc.internal.pageSize.width / 2, y, { align: "center" });
            y += 15;

            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);

            // 1. Dados Pessoais
            doc.setFontSize(14);
            doc.text("1. Dados Pessoais", margin, y);
            y += 10;
            doc.setFontSize(11);
            doc.text(`Nome Completo: ${form.fullName.value || 'Não informado'}`, margin, y); y += lineHeight;
            doc.text(`Data de Nascimento: ${formatDateBr(form.dob.value) || 'Não informado'}`, margin, y); y += lineHeight;
            doc.text(`Gênero: ${form.gender.value || 'Não informado'}`, margin, y); y += lineHeight;
            doc.text(`Nacionalidade Atual: ${form.nationality.value || 'Não informado'}`, margin, y); y += lineHeight;
            doc.text(`Outras Nacionalidades: ${form.otherNationalities.value || 'Não informado'}`, margin, y); y += lineHeight;
            doc.text(`País de Nascimento: ${form.countryOfBirth.value || 'Não informado'}`, margin, y); y += lineHeight;
            doc.text(`Cidade de Nascimento: ${form.cityOfBirth.value || 'Não informado'}`, margin, y); y += lineHeight;
            doc.text(`Estado Civil: ${form.maritalStatus.value || 'Não informado'}`, margin, y); y += lineHeight;

            if (['Casado', 'Divorciado', 'Viúvo', 'União Estável'].includes(form.maritalStatus.value)) {
                if (y + 40 > doc.internal.pageSize.height - margin) { doc.addPage(); y = margin; }
                doc.setFontSize(12);
                doc.text("Dados do Cônjuge", margin + 5, y); y += 10;
                doc.setFontSize(11);
                doc.text(`Nome Completo do Cônjuge: ${form.spouseFullName.value || 'Não informado'}`, margin, y); y += lineHeight;
                doc.text(`Data de Nascimento do Cônjuge: ${formatDateBr(form.spouseDob.value) || 'Não informado'}`, margin, y); y += lineHeight;
                doc.text(`País de Nascimento do Cônjuge: ${form.spouseCountryOfBirth.value || 'Não informado'}`, margin, y); y += lineHeight;
                if (form.maritalStatus.value === 'Viúvo') {
                    doc.text(`Data de Falecimento do Cônjuge: ${formatDateBr(form.spouseDod.value) || 'Não informado'}`, margin, y); y += lineHeight;
                }
            }
            y += 5;

            // 2. Dados do Passaporte
            if (y + 40 > doc.internal.pageSize.height - margin) { doc.addPage(); y = margin; }
            doc.setFontSize(14);
            doc.text("2. Dados do Passaporte", margin, y);
            y += 10;
            doc.setFontSize(11);
            doc.text(`Número do Passaporte: ${form.passportNumber.value || 'Não informado'}`, margin, y); y += lineHeight;
            doc.text(`Data de Emissão: ${formatDateBr(form.issueDate.value) || 'Não informado'}`, margin, y); y += lineHeight;
            doc.text(`Data de Validade: ${formatDateBr(form.expiryDate.value) || 'Não informado'}`, margin, y); y += lineHeight;
            doc.text(`País Emissor: ${form.issuingCountry.value || 'Não informado'}`, margin, y); y += lineHeight;
            y += 5;

            // 3. Endereço Atual e Contato
            if (y + 40 > doc.internal.pageSize.height - margin) { doc.addPage(); y = margin; }
            doc.setFontSize(14);
            doc.text("3. Endereço Atual e Contato", margin, y);
            y += 10;
            doc.setFontSize(11);
            doc.text(`Endereço: ${form.currentAddress.value || 'Não informado'}`, margin, y); y += lineHeight;
            doc.text(`Cidade: ${form.currentCity.value || 'Não informado'}`, margin, y); y += lineHeight;
            doc.text(`Estado/Província: ${form.currentState.value || 'Não informado'}`, margin, y); y += lineHeight;
            doc.text(`CEP/Código Postal: ${form.currentZipCode.value || 'Não informado'}`, margin, y); y += lineHeight;
            doc.text(`País: ${form.currentCountry.value || 'Não informado'}`, margin, y); y += lineHeight;
            doc.text(`Telefone: ${form.phone.value || 'Não informado'}`, margin, y); y += lineHeight;
            doc.text(`E-mail: ${form.email.value || 'Não informado'}`, margin, y); y += lineHeight;
            y += 5;

            // 4. Informações Familiares
            if (y + 40 > doc.internal.pageSize.height - margin) { doc.addPage(); y = margin; }
            doc.setFontSize(14);
            doc.text("4. Informações Familiares", margin, y);
            y += 10;
            doc.setFontSize(11);
            doc.text(`Pais Vivos: ${form.parentsAlive.value || 'Não informado'}`, margin, y); y += lineHeight;
            if (form.parentsAlive.value === 'Sim') {
                doc.text(`Nome Completo do Pai: ${form.fatherFullName.value || 'Não informado'}`, margin, y); y += lineHeight;
                doc.text(`Data de Nascimento do Pai: ${formatDateBr(form.fatherDob.value) || 'Não informado'}`, margin, y); y += lineHeight;
                doc.text(`Nome Completo da Mãe: ${form.motherFullName.value || 'Não informado'}`, margin, y); y += lineHeight;
                doc.text(`Data de Nascimento da Mãe: ${formatDateBr(form.motherDob.value) || 'Não informado'}`, margin, y); y += lineHeight;
                doc.text(`Pais nos EUA: ${form.parentsInUS.value || 'Não informado'}`, margin, y); y += lineHeight;
                if (form.parentsInUS.value === 'Sim') {
                    doc.text(`Explicação sobre Pais nos EUA: ${form.parentsInUSExplanation.value || 'Não informado'}`, margin, y); y += lineHeight;
                }
            }
            doc.text(`Conhecidos nos EUA: ${form.knownInUS.value || 'Não informado'}`, margin, y); y += lineHeight;
            if (form.knownInUS.value === 'Sim') {
                doc.text(`Nome Completo do Conhecido: ${form.knownName.value || 'Não informado'}`, margin, y); y += lineHeight;
                doc.text(`Telefone do Conhecido: ${form.knownPhone.value || 'Não informado'}`, margin, y); y += lineHeight;
                doc.text(`E-mail do Conhecido: ${form.knownEmail.value || 'Não informado'}`, margin, y); y += lineHeight;
                doc.text(`Vínculo com o Solicitante: ${form.knownRelationship.value || 'Não informado'}`, margin, y); y += lineHeight;
            }
            y += 5;

            // 5. Histórico de Endereços
            if (y + 40 > doc.internal.pageSize.height - margin) { doc.addPage(); y = margin; }
            doc.setFontSize(14);
            doc.text("5. Histórico de Endereços (Últimos 5 anos)", margin, y);
            y += 10;
            doc.setFontSize(11);
            const pastAddresses = document.querySelectorAll('#addressHistoryContainer .address-entry');
            let hasAddressHistory = false;
            pastAddresses.forEach(entry => {
                if (entry.querySelector('input[name="pastAddress[]"]').value || entry.querySelector('input[name="pastCity[]"]').value) {
                    hasAddressHistory = true;
                }
            });
            if (!hasAddressHistory) {
                 doc.text('Nenhum endereço anterior informado.', margin, y);
                 y += lineHeight;
            } else {
                pastAddresses.forEach((entry, index) => {
                    if (y + 3 * lineHeight > doc.internal.pageSize.height - margin) { doc.addPage(); y = margin; }
                    const address = entry.querySelector('input[name="pastAddress[]"]').value || 'Não informado';
                    const city = entry.querySelector('input[name="pastCity[]"]').value || 'Não informado';
                    const state = entry.querySelector('input[name="pastState[]"]').value || 'Não informado';
                    const country = entry.querySelector('input[name="pastCountry[]"]').value || 'Não informado';
                    const from = entry.querySelector('input[name="pastAddressFrom[]"]').value || 'Não informado';
                    const to = entry.querySelector('input[name="pastAddressTo[]"]').value || 'Não informado';
                    doc.text(`Endereço ${index + 1}: ${address}, ${city}, ${state}, ${country}`, margin, y); y += lineHeight;
                    doc.text(`Período: ${from} a ${to}`, margin, y); y += lineHeight;
                    y += 3; // Small gap between entries
                });
            }
            y += 5;

            // 6. Histórico de Emprego
            if (y + 40 > doc.internal.pageSize.height - margin) { doc.addPage(); y = margin; }
            doc.setFontSize(14);
            doc.text("6. Histórico de Emprego (Últimos 5 anos)", margin, y);
            y += 10;
            doc.setFontSize(11);
            const employmentEntries = document.querySelectorAll('#employmentHistoryContainer .employment-entry');
            let hasEmploymentHistory = false;
            employmentEntries.forEach(entry => {
                if (entry.querySelector('input[name="employerName[]"]').value || entry.querySelector('input[name="occupation[]"]').value) {
                    hasEmploymentHistory = true;
                }
            });
            if (!hasEmploymentHistory) {
                doc.text('Nenhum histórico de emprego informado.', margin, y);
                y += lineHeight;
            } else {
                employmentEntries.forEach((entry, index) => {
                    if (y + 3 * lineHeight > doc.internal.pageSize.height - margin) { doc.addPage(); y = margin; }
                    const employer = entry.querySelector('input[name="employerName[]"]').value || 'Não informado';
                    const occupation = entry.querySelector('input[name="occupation[]"]').value || 'Não informado';
                    const employerAddress = entry.querySelector('input[name="employerAddress[]"]').value || 'Não informado';
                    const from = entry.querySelector('input[name="employmentFrom[]"]').value || 'Não informado';
                    const to = entry.querySelector('input[name="employmentTo[]"]').value || 'Não informado';
                    doc.text(`Emprego ${index + 1}: ${employer} - ${occupation}`, margin, y); y += lineHeight;
                    doc.text(`Endereço: ${employerAddress}`, margin, y); y += lineHeight;
                    doc.text(`Período: ${from} a ${to}`, margin, y); y += lineHeight;
                    y += 3;
                });
            }
            y += 5;

            // 7. Histórico de Viagens Internacionais
            if (y + 40 > doc.internal.pageSize.height - margin) { doc.addPage(); y = margin; }
            doc.setFontSize(14);
            doc.text("7. Histórico de Viagens Internacionais (Últimos 5 anos)", margin, y);
            y += 10;
            doc.setFontSize(11);
            const travelEntries = document.querySelectorAll('#travelHistoryContainer .travel-entry');
            let hasTravelHistory = false;
            travelEntries.forEach(entry => {
                if (entry.querySelector('input[name="countryVisited[]"]').value || entry.querySelector('textarea[name="travelPurpose[]"]').value) {
                    hasTravelHistory = true;
                }
            });
            if (!hasTravelHistory) {
                doc.text('Nenhum histórico de viagem informado.', margin, y);
                y += lineHeight;
            } else {
                travelEntries.forEach((entry, index) => {
                    if (y + 4 * lineHeight > doc.internal.pageSize.height - margin) { doc.addPage(); y = margin; }
                    const country = entry.querySelector('input[name="countryVisited[]"]').value || 'Não informado';
                    const entryDate = entry.querySelector('input[name="entryDate[]"]').value || 'Não informado';
                    const exitDate = entry.querySelector('input[name="exitDate[]"]').value || 'Não informado';
                    const purpose = entry.querySelector('textarea[name="travelPurpose[]"]').value || 'Não informado';
                    doc.text(`Viagem ${index + 1}: País: ${country}`, margin, y); y += lineHeight;
                    doc.text(`Período: ${entryDate} a ${exitDate}`, margin, y); y += lineHeight;
                    doc.text(`Propósito: ${purpose}`, margin, y); y += lineHeight;
                    y += 3;
                });
            }
            y += 5;

            // 8. Perguntas de Elegibilidade e Histórico
            if (y + 80 > doc.internal.pageSize.height - margin) { doc.addPage(); y = margin; }
            doc.setFontSize(14);
            doc.text("8. Perguntas de Elegibilidade e Histórico", margin, y);
            y += 10;
            doc.setFontSize(11);

            const criminalRecord = form.criminalRecord.value || 'Não informado';
            const crimeExplanation = form.crimeExplanation.value || '';
            doc.text(`a. Condenação criminal/Acusação/Mandados: ${criminalRecord}${criminalRecord === 'Sim' ? ` - ${crimeExplanation}` : ''}`, margin, y); y += lineHeight;

            const violationRecord = form.violationRecord.value || 'Não informado';
            const violationExplanation = form.violationExplanation.value || '';
            doc.text(`b. Violação alfandegária/imigração/agrícola: ${violationRecord}${violationRecord === 'Sim' ? ` - ${violationExplanation}` : ''}`, margin, y); y += lineHeight;

            const investigationStatus = form.investigationStatus.value || 'Não informado';
            const investigationExplanation = form.investigationExplanation.value || '';
            doc.text(`c. Investigação em andamento: ${investigationStatus}${investigationStatus === 'Sim' ? ` - ${investigationExplanation}` : ''}`, margin, y); y += lineHeight;

            const falseInformation = form.falseInformation.value || 'Não informado';
            const falseInfoExplanation = form.falseInfoExplanation.value || '';
            doc.text(`d. Informações falsas/incompletas: ${falseInformation}${falseInformation === 'Sim' ? ` - ${falseInfoExplanation}` : ''}`, margin, y); y += lineHeight;
            y += 5;

            // 9. Declaração
            if (y + 120 > doc.internal.pageSize.height - margin) { doc.addPage(); y = margin; }
            doc.setFontSize(14);
            doc.text("9. Declaração e Autorização", margin, y);
            y += 10;
            doc.setFontSize(11);

            const declaracaoNome = form.declaracaoNome.value || 'Não informado';
            y = addJustifiedText(doc, `Eu, ${declaracaoNome}, declaro, sob as penas da lei, que li e compreendi integralmente todas as questões contidas nesta solicitação de visto e afirmo que as respostas por mim fornecidas são verdadeiras, completas e corretas, conforme o meu melhor conhecimento e convicção.`, margin, y, doc.internal.pageSize.width - 2 * margin, lineHeight);
            y += 5;

            doc.setFontSize(11);
            doc.setFont(doc.getFont().fontName, 'bold');
            doc.text("Declaro estar ciente de que:", margin, y);
            y += lineHeight;
            doc.setFont(doc.getFont().fontName, 'normal');

            const declarationPoints1 = [
                "1. Qualquer declaração falsa, incompleta ou enganosa poderá resultar na recusa permanente do visto ou na negativa de admissão nos Estados Unidos, conforme disposto na legislação aplicável.",
                "2. Todas as informações prestadas nesta solicitação constituem declarações juramentadas, realizadas sob pena de perjúrio, nos termos do disposto no _28 U.S.C. § 1746_.",
                "3. Informações adicionais poderão ser requisitadas pelas autoridades competentes após a análise desta solicitação, sendo minha responsabilidade fornecê-las tempestivamente.",
                "4. As informações contidas nesta solicitação poderão ser compartilhadas com outras agências governamentais dos Estados Unidos, que possuem autoridade para utilizá-las para fins de aplicação da lei ou para propósitos imigratórios, conforme permitido pela legislação vigente.",
                "5. A fotografia fornecida com esta solicitação poderá ser utilizada pelas autoridades americanas para fins de verificação de identidade, empregabilidade ou outros objetivos legais previstos na legislação dos Estados Unidos."
            ];
            declarationPoints1.forEach(point => {
                if (y + lineHeight > doc.internal.pageSize.height - margin) { doc.addPage(); y = margin; }
                y = addJustifiedText(doc, point, margin, y, doc.internal.pageSize.width - 2 * margin, lineHeight);
            });
            y += 5;

            doc.setFont(doc.getFont().fontName, 'bold');
            doc.text("Declaro ainda:", margin, y);
            y += lineHeight;
            doc.setFont(doc.getFont().fontName, 'normal');

            const declarationPoints2 = [
                "6. Que sou exclusivamente responsável pela autenticidade e exatidão dos documentos apresentados e das informações prestadas nesta solicitação.",
                "7. Que tenho pleno conhecimento de que a concessão ou negativa do visto é prerrogativa exclusiva da Autoridade Consular Americana, não cabendo a terceiros qualquer ingerência sobre tal decisão.",
                "8. Que estou ciente de que, em processos de renovação de visto, entrevistas presenciais poderão ser exigidas a critério exclusivo da Autoridade Consular Americana.",
                "9. Que reconheço que o serviço contratado constitui assessoria relacionada ao processo de preenchimento de documentação, agendamento de biometria e entrevista, não abrangendo serviços de entrega ou retirada de documentos no Centro de Atendimento ao Solicitante de Visto (CASV), sendo necessária a contratação de um agente colaborador, caso eu deseje tais serviços adicionais.",
                "10. Que a aposição de minha assinatura eletrônica neste documento possui validade jurídica, conforme a legislação aplicável, e representa meu reconhecimento expresso dos serviços contratados."
            ];
            declarationPoints2.forEach(point => {
                if (y + lineHeight > doc.internal.pageSize.height - margin) { doc.addPage(); y = margin; }
                y = addJustifiedText(doc, point, margin, y, doc.internal.pageSize.width - 2 * margin, lineHeight);
            });
            y += 5;

            doc.setFont(doc.getFont().fontName, 'bold');
            doc.text("Autorização:", margin, y);
            y += lineHeight;
            doc.setFont(doc.getFont().fontName, 'normal');

            const authorizationText = `Declaro, por fim, ter revisado e conferido todos os dados por mim apresentados, autorizando expressamente a empresa **Objetivo Turismo Ltda.**, contratada diretamente por mim ou por intermédio de minha agência, a proceder com o envio eletrônico do Formulário DS-160 ao Consulado Americano, bem como a realizar o pagamento das taxas e o agendamento necessários à tramitação do meu pedido de visto.`;
            if (y + lineHeight > doc.internal.pageSize.height - margin) { doc.addPage(); y = margin; }
            y = addJustifiedText(doc, authorizationText, margin, y, doc.internal.pageSize.width - 2 * margin, lineHeight);
            y += 5;

            doc.text(`Local: ${form.declaracaoLocal.value || 'Não informado'}`, margin, y); y += lineHeight;
            doc.text(`Data: ${formatDateBr(form.declaracaoData.value) || 'Não informado'}`, margin, y); y += lineHeight;
            doc.text(`Concordo com os termos da declaração: ${form.aceiteDeclaracao.checked ? 'Sim' : 'Não'}`, margin, y); y += lineHeight;
            y += 15;

            // Finalização do PDF
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, margin, doc.internal.pageSize.height - 10);
            doc.text("Formulário de Inscrição Global Entry", doc.internal.pageSize.width - margin, doc.internal.pageSize.height - 10, { align: "right" });

            // Salva o PDF no navegador
            const pdfBlob = doc.output('blob');
            const solicitanteNomeParaArquivo = form.fullName.value ? form.fullName.value.replace(/\s+/g, '_') : 'Global_Entry_Solicitante';
            const pdfFileName = `GlobalEntry_${solicitanteNomeParaArquivo}_${new Date().getTime()}.pdf`;

            try {
                // Firebase Storage upload
                const storageRef = ref(storage, `global_entry_forms/${pdfFileName}`);
                await uploadBytes(storageRef, pdfBlob);
                const downloadURL = await getDownloadURL(storageRef);

                console.log('PDF uploaded successfully:', downloadURL);

                // Envio para o WhatsApp
                let whatsappMessage = `*Novo Formulário Global Entry Recebido!* \n\n`;
                whatsappMessage += `*Nome do Solicitante:* ${form.fullName.value || 'Não informado'}\n`;
                whatsappMessage += `*E-mail:* ${form.email.value || 'Não informado'}\n`;
                whatsappMessage += `*Telefone do Cliente:* ${form.phone.value || 'Não informado'}\n`;
                whatsappMessage += `*Link para o Formulário Completo (PDF):*\n${downloadURL}\n\n`;
                whatsappMessage += `Por favor, revise o PDF para prosseguir.`;

                const whatsappUrlFixed = `https://wa.me/${fixedWhatsAppNumber}?text=${encodeURIComponent(whatsappMessage)}`;
                window.open(whatsappUrlFixed, '_blank');

                alert('Formulário Global Entry enviado com sucesso! O PDF foi gerado e o link enviado para o WhatsApp da empresa.');

            } catch (error) {
                console.error("Erro ao fazer upload ou enviar para WhatsApp:", error);
                alert("Ocorreu um erro ao gerar ou enviar o PDF. Por favor, tente novamente. Detalhes: " + error.message);
            }
        }
    </script>
</body>
</html>
