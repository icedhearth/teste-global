<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário de Inscrição Global Entry</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.16/jspdf.autotable.min.js"></script>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.0.0/firebase-storage.js';
        
        // Suas credenciais do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAkBV0rHEghBOHl2mDOs6rMDHkUgYMxFr0",
            authDomain: "visaformulariostorage.firebaseapp.com",
            projectId: "visaformulariostorage",
            storageBucket: "visaformulariostorage.appspot.com",
            messagingSenderId: "720170394408",
            appId: "1:720170394408:web:b1c294c39c489388f6261d",
            measurementId: "G-ZFCV4JEEFT"
        };

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);

        // Torna as funções do Firebase disponíveis globalmente (necessário para o script não-módulo)
        window.firebaseApp = app;
        window.firebaseStorage = storage;
        window.firebaseRef = ref;
        window.firebaseUploadBytes = uploadBytes;
        window.firebaseGetDownloadURL = getDownloadURL;
    </script>
    
    <style>
        /* Seus estilos CSS, que são os mesmos do último código enviado (do DS-160) */
        /* Estilos Globais */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5; /* Fundo cinza claro */
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 20px; /* Padding padrão para desktop */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh; /* Altura mínima da tela */
            box-sizing: border-box; /* Inclui padding e border na largura total */
        }

        .container {
            background-color: #ffffff;
            padding: 40px; /* Padding padrão para desktop */
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); /* Sombra mais suave */
            max-width: 850px; /* Largura máxima para melhor leitura */
            width: 100%;
            margin-top: 20px;
            margin-bottom: 20px;
            box-sizing: border-box; /* Inclui padding e border na largura total */
        }

        h1 {
            color: #003087; /* Azul marinho para o título principal */
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.4em; /* Título maior */
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.05); /* Sombra sutil no texto */
        }

        h3 {
            color: #0056b3; /* Azul médio para títulos de seção */
            border-bottom: 3px solid #007bff; /* Borda azul vibrante */
            padding-bottom: 10px;
            margin-top: 35px;
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: 600;
        }

        h4 {
            color: #007bff; /* Azul claro para subtítulos */
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        p {
            margin-bottom: 15px;
            font-size: 1.05em;
            color: #555;
        }

        label {
            display: block;
            margin: 18px 0 8px; /* Mais espaço acima do label */
            font-weight: 600;
            color: #444;
            font-size: 0.98em;
        }

        input[type="text"],
        input[type="date"],
        input[type="tel"],
        input[type="email"],
        textarea,
        select,
        input[type="month"], /* Adicionado para campos de mês/ano */
        input[type="number"] {
            width: calc(100% - 24px); /* Ajuste para padding e borda */
            padding: 12px;
            margin-bottom: 18px; /* Mais espaço abaixo dos campos */
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            box-sizing: border-box;
        }

        input[type="text"]:focus,
        input[type="date"]:focus,
        input[type="tel"]:focus,
        input[type="email"]:focus,
        textarea:focus,
        select:focus,
        input[type="month"]:focus, /* Adicionado para campos de mês/ano */
        input[type="number"]:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); /* Efeito de foco mais suave */
            outline: none;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        input[type="checkbox"] {
            width: auto; /* Checkbox não ocupa 100% da largura */
            margin-right: 10px;
            transform: scale(1.2); /* Aumenta um pouco o checkbox */
            vertical-align: middle; /* Alinha com o texto */
            margin-top: -3px; /* Pequeno ajuste para alinhamento visual */
        }

        button { /* Alterado de type="submit" para abranger todos os botões */
            background-color: #007bff; /* Azul padrão para botões */
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease;
            margin: 0 5px; /* Espaçamento entre botões */
        }

        button:hover {
            background-color: #0056b3;
        }
        
        button[type="submit"], .button-group button { /* Estilo específico para o botão de envio principal */
            background-color: #28a745; /* Verde vibrante */
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 1.15em; /* Texto maior no botão */
            font-weight: 600;
            width: 100%;
            margin-top: 40px; /* Mais espaço antes do botão */
            letter-spacing: 0.5px; /* Espaçamento entre letras */
        }

        button[type="submit"]:hover, .button-group button:hover {
            background-color: #218838; /* Verde mais escuro no hover */
            transform: translateY(-2px); /* Efeito de elevação */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Sombra no hover */
        }
        
        button:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }


        hr {
            border: 0;
            border-top: 2px dashed #e0e0e0; /* Linha tracejada suave */
            margin: 40px 0; /* Espaço maior para as linhas */
        }

        /* Estilos para seções que podem ser ocultadas/exibidas (mantendo display: none) */
        .hidden-section {
            display: none;
        }

        .conditional-section {
            background-color: #f8f9fa; /* Fundo sutil para seções condicionais */
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-top: 25px;
            margin-bottom: 25px;
        }

        /* Estilos para a declaração */
        .declaration-section {
            background-color: #e6f7ff; /* Fundo azul claro */
            border: 1px solid #99d6ff;
            border-radius: 10px;
            padding: 30px;
            margin-top: 50px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); /* Sombra interna sutil */
        }

        .declaration-section h3 {
            border-bottom: 2px solid #0056b3;
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 25px;
        }

        .declaration-section ol {
            padding-left: 28px;
            margin-bottom: 20px;
            font-size: 0.95em;
            color: #444;
        }

        .declaration-section ol li {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .declaration-section p {
            margin-bottom: 10px;
            font-size: 0.98em;
            color: #333;
        }

        .declaration-section strong {
            color: #0056b3;
        }

        .declaration-section input[type="text"][name="declaracaoNome"],
        .declaration-section input[type="text"][name="declaracaoLocal"],
        .declaration-section input[type="date"][name="declaracaoData"] {
            width: auto; /* Permite que o input se ajuste ao conteúdo */
            display: inline-block; /* Alinha com o texto */
            padding: 8px;
            font-size: 0.9em;
            border-radius: 5px;
            margin-left: 5px; /* Pequeno espaçamento */
        }

        .declaration-section label input[type="checkbox"] {
            vertical-align: middle;
            margin-top: -2px; /* Ajuste fino para alinhamento */
        }

        /* *********************************************************************************** */
        /* Estilos para Responsividade (Mobile First) */
        /* Aplicados a partir de telas menores e sobrescritos por telas maiores se necessário */
        /* *********************************************************************************** */

        /* Ajustes gerais para telas pequenas */
        body {
            padding: 10px; /* Menor padding nas bordas para celulares */
        }

        .container {
            padding: 20px; /* Menor padding interno para celulares */
            margin-top: 10px;
            margin-bottom: 10px;
            border-radius: 8px; /* Borda menos arredondada para mobile */
        }

        h1 {
            font-size: 1.8em; /* Título principal menor em mobile */
            margin-bottom: 20px;
        }

        h3 {
            font-size: 1.4em; /* Títulos de seção menores em mobile */
            margin-top: 25px;
            margin-bottom: 15px;
            border-bottom-width: 2px; /* Borda ligeiramente mais fina */
        }

        h4 {
            font-size: 1.1em; /* Subtítulos menores em mobile */
            margin-top: 20px;
            margin-bottom: 10px;
        }

        p, label {
            font-size: 0.95em; /* Texto ligeiramente menor */
        }

        input[type="text"],
        input[type="date"],
        input[type="tel"],
        input[type="email"],
        input[type="month"],
        input[type="number"],
        textarea,
        select {
            width: calc(100% - 20px); /* Ajuste para padding menor (10px + 10px) */
            padding: 10px; /* Padding menor para inputs em mobile */
            margin-bottom: 15px; /* Menor espaço abaixo */
            font-size: 0.95em;
        }

        button[type="submit"], .button-group button {
            padding: 12px 20px; /* Padding menor para o botão */
            font-size: 1em; /* Texto menor no botão */
            margin-top: 30px; /* Menor espaço antes do botão */
        }

        /* Ajustes específicos para a seção de declaração em mobile */
        .declaration-section {
            padding: 15px; /* Menor padding */
            margin-top: 30px;
        }
        .declaration-section ol {
            padding-left: 20px; /* Ajuste do padding da lista */
            font-size: 0.9em;
        }
        .declaration-section p {
            font-size: 0.9em;
        }
        .declaration-section input[type="text"][name="declaracaoNome"],
        .declaration-section input[type="text"][name="declaracaoLocal"],
        .declaration-section input[type="date"][name="declaracaoData"] {
            width: 100%; /* Ocupa a largura total para melhor preenchimento */
            display: block; /* Cada one em sua própria linha */
            margin-left: 0;
            margin-top: 5px; /* Espaçamento entre eles */
            margin-bottom: 10px;
        }
        .declaration-section label input[type="checkbox"] {
            margin-left: 0; /* Alinha o checkbox */
        }

        /* Media Query para telas menores que 600px (smartphones) */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
                margin-top: 10px;
                margin-bottom: 10px;
            }
            h1 {
                font-size: 1.6em;
            }
            h3 {
                font-size: 1.3em;
                margin-top: 20px;
                margin-bottom: 15px;
            }
            h4 {
                font-size: 1.1em;
            }
            p, label {
                font-size: 0.9em;
            }
            input[type="text"],
            input[type="date"],
            input[type="tel"],
            input[type="email"],
            input[type="month"],
            input[type="number"],
            textarea,
            select {
                padding: 8px;
                font-size: 0.9em;
            }
            button[type="submit"], .button-group button {
                padding: 10px 15px;
                font-size: 0.95em;
            }
            .declaration-section ol li {
                margin-bottom: 8px;
            }
        }

        /* Media Query para telas muito pequenas, caso necessário (ex: 320px de largura) */
        @media (max-width: 320px) {
            h1 {
                font-size: 1.4em;
            }
            h3 {
                font-size: 1.2em;
            }
            input[type="text"],
            input[type="date"],
            input[type="tel"],
            input[type="email"],
            input[type="month"],
            input[type="number"],
            textarea,
            select {
                font-size: 0.85em;
            }
            button[type="submit"], .button-group button {
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Formulário de Inscrição Global Entry</h1>
        <p style="text-align: center;">Preencha o formulário com seus dados para a aplicação do Global Entry.</p>

        <form id="globalEntryForm">
            <div class="form-section">
                <h3>1. Dados Pessoais</h3>
                <div class="form-group">
                    <label for="fullName">Nome Completo (como no passaporte):</label>
                    <input type="text" id="fullName" name="fullName">
                </div>
                <div class="form-group">
                    <label for="dob">Data de Nascimento:</label>
                    <input type="date" id="dob" name="dob">
                </div>
                <div class="form-group">
                    <label for="gender">Gênero:</label>
                    <select id="gender" name="gender">
                        <option value="">Selecione</option>
                        <option value="Masculino">Masculino</option>
                        <option value="Feminino">Feminino</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="nationality">Nacionalidade Atual:</label>
                    <input type="text" id="nationality" name="nationality">
                </div>
                <div class="form-group">
                    <label for="otherNationalities">Outras Nacionalidades (se houver):</label>
                    <input type="text" id="otherNationalities" name="otherNationalities">
                </div>
                <div class="form-group">
                    <label for="countryOfBirth">País de Nascimento:</label>
                    <input type="text" id="countryOfBirth" name="countryOfBirth">
                </div>
                <div class="form-group">
                    <label for="cityOfBirth">Cidade de Nascimento:</label>
                    <input type="text" id="cityOfBirth" name="cityOfBirth">
                </div>
                <div class="form-group">
                    <label for="maritalStatus">Estado Civil:</label>
                    <select id="maritalStatus" name="maritalStatus">
                        <option value="">Selecione</option>
                        <option value="Solteiro">Solteiro</option>
                        <option value="Casado">Casado</option>
                        <option value="Divorciado">Divorciado</option>
                        <option value="Viúvo">Viúvo</option>
                        <option value="União Estável">União Estável</option>
                    </select>
                </div>

                <div id="spouseInfo" class="conditional-section hidden-section">
                    <h4>Dados do Cônjuge</h4>
                    <div class="form-group">
                        <label for="spouseFullName">Nome Completo do Cônjuge:</label>
                        <input type="text" id="spouseFullName" name="spouseFullName">
                    </div>
                    <div class="form-group">
                        <label for="spouseDob">Data de Nascimento do Cônjuge:</label>
                        <input type="date" id="spouseDob" name="spouseDob">
                    </div>
                    <div class="form-group">
                        <label for="spouseCountryOfBirth">País de Nascimento do Cônjuge:</label>
                        <input type="text" id="spouseCountryOfBirth" name="spouseCountryOfBirth">
                    </div>
                    <div id="spouseDeathInfo" class="conditional-section hidden-section">
                        <div class="form-group">
                            <label for="spouseDod">Data de Falecimento do Cônjuge:</label>
                            <input type="date" id="spouseDod" name="spouseDod">
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>2. Dados do Passaporte</h3>
                <div class="form-group">
                    <label for="passportNumber">Número do Passaporte:</label>
                    <input type="text" id="passportNumber" name="passportNumber">
                </div>
                <div class="form-group">
                    <label for="issueDate">Data de Emissão:</label>
                    <input type="date" id="issueDate" name="issueDate">
                </div>
                <div class="form-group">
                    <label for="expiryDate">Data de Validade:</label>
                    <input type="date" id="expiryDate" name="expiryDate">
                </div>
                <div class="form-group">
                    <label for="issuingCountry">País Emissor:</label>
                    <input type="text" id="issuingCountry" name="issuingCountry">
                </div>
            </div>

            <div class="form-section">
                <h3>3. Endereço Atual e Contato</h3>
                <div class="form-group">
                    <label for="currentAddress">Endereço (Rua, Número, Complemento):</label>
                    <input type="text" id="currentAddress" name="currentAddress">
                </div>
                <div class="form-group">
                    <label for="currentCity">Cidade:</label>
                    <input type="text" id="currentCity" name="currentCity">
                </div>
                <div class="form-group">
                    <label for="currentState">Estado/Província:</label>
                    <input type="text" id="currentState" name="currentState">
                </div>
                <div class="form-group">
                    <label for="currentZipCode">CEP/Código Postal:</label>
                    <input type="text" id="currentZipCode" name="currentZipCode">
                </div>
                <div class="form-group">
                    <label for="currentCountry">País:</label>
                    <input type="text" id="currentCountry" name="currentCountry">
                </div>
                <div class="form-group">
                    <label for="phone">Telefone:</label>
                    <input type="tel" id="phone" name="phone" placeholder="(XX) XXXXX-XXXX">
                </div>
                <div class="form-group">
                    <label for="email">E-mail:</label>
                    <input type="email" id="email" name="email">
                </div>
            </div>

            <div class="form-section">
                <h3>4. Informações Familiares</h3>
                <div class="form-group">
                    <label for="parentsAlive">Seus pais estão vivos?</label>
                    <select id="parentsAlive" name="parentsAlive">
                        <option value="">Selecione</option>
                        <option value="Sim">Sim</option>
                        <option value="Não">Não</option>
                    </select>
                </div>
                <div id="parentsInfo" class="conditional-section hidden-section">
                    <div class="form-group">
                        <label for="fatherFullName">Nome Completo do Pai:</label>
                        <input type="text" id="fatherFullName" name="fatherFullName">
                    </div>
                    <div class="form-group">
                        <label for="fatherDob">Data de Nascimento do Pai:</label>
                        <input type="date" id="fatherDob" name="fatherDob">
                    </div>
                    <div class="form-group">
                        <label for="motherFullName">Nome Completo da Mãe:</label>
                        <input type="text" id="motherFullName" name="motherFullName">
                    </div>
                    <div class="form-group">
                        <label for="motherDob">Data de Nascimento da Mãe:</label>
                        <input type="date" id="motherDob" name="motherDob">
                    </div>
                    <div class="form-group">
                        <label for="parentsInUS">Seus pais estão nos EUA?</label>
                    <select id="parentsInUS" name="parentsInUS">
                            <option value="">Selecione</option>
                            <option value="Sim">Sim</option>
                            <option value="Não">Não</option>
                        </select>
                    </div>
                    <div id="parentsInUSDetails" class="conditional-section hidden-section">
                        <div class="form-group">
                            <label for="parentsInUSExplanation">Explique a situação dos seus pais nos EUA:</label>
                            <textarea id="parentsInUSExplanation" name="parentsInUSExplanation" rows="2"></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="knownInUS">Você tem conhecidos nos EUA?</label>
                    <select id="knownInUS" name="knownInUS">
                        <option value="">Selecione</option>
                        <option value="Sim">Sim</option>
                        <option value="Não">Não</option>
                    </select>
                </div>
                <div id="knownInUSInfo" class="conditional-section hidden-section">
                    <h4>Dados do Conhecido nos EUA</h4>
                    <div class="form-group">
                        <label for="knownName">Nome Completo do Conhecido:</label>
                        <input type="text" id="knownName" name="knownName">
                    </div>
                    <div class="form-group">
                        <label for="knownPhone">Telefone do Conhecido:</label>
                        <input type="tel" id="knownPhone" name="knownPhone">
                    </div>
                    <div class="form-group">
                        <label for="knownEmail">E-mail do Conhecido:</label>
                        <input type="email" id="knownEmail" name="knownEmail">
                    </div>
                    <div class="form-group">
                        <label for="knownRelationship">Vínculo com o Solicitante:</label>
                        <input type="text" id="knownRelationship" name="knownRelationship" placeholder="Ex: amigo, parente, colega">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>5. Histórico de Endereços (Últimos 5 anos)</h3>
                <p>Liste todos os endereços onde você residiu nos últimos 5 anos. Comece pelo mais recente.</p>
                <div id="addressHistoryContainer">
                    <div class="address-entry">
                        <div class="form-group">
                            <label>Endereço:</label>
                            <input type="text" name="pastAddress[]" placeholder="Rua, Número, Complemento">
                        </div>
                        <div class="form-group">
                            <label>Cidade:</label>
                            <input type="text" name="pastCity[]">
                        </div>
                        <div class="form-group">
                            <label>Estado/Província:</label>
                            <input type="text" name="pastState[]">
                        </div>
                        <div class="form-group">
                            <label>País:</label>
                            <input type="text" name="pastCountry[]">
                        </div>
                        <div class="form-group">
                            <label>De (MM/AAAA):</label>
                            <input type="month" name="pastAddressFrom[]">
                        </div>
                        <div class="form-group">
                            <label>Até (MM/AAAA):</label>
                            <input type="month" name="pastAddressTo[]">
                        </div>
                    </div>
                </div>
                <button type="button" onclick="addAddressEntry()" style="background-color: #28a745; margin-top: 10px;">Adicionar Endereço</button>
            </div>

            <div class="form-section">
                <h3>6. Histórico de Emprego (Últimos 5 anos)</h3>
                <p>Liste seu histórico de emprego nos últimos 5 anos. Comece pelo mais recente.</p>
                <div id="employmentHistoryContainer">
                    <div class="employment-entry">
                        <div class="form-group">
                            <label>Empregador:</label>
                            <input type="text" name="employerName[]">
                        </div>
                        <div class="form-group">
                            <label>Cargo:</label>
                            <input type="text" name="occupation[]">
                        </div>
                        <div class="form-group">
                            <label>Endereço do Empregador:</label>
                            <input type="text" name="employerAddress[]" placeholder="Rua, Número, Cidade, País">
                        </div>
                        <div class="form-group">
                            <label>De (MM/AAAA):</label>
                            <input type="month" name="employmentFrom[]">
                        </div>
                        <div class="form-group">
                            <label>Até (MM/AAAA):</label>
                            <input type="month" name="employmentTo[]">
                        </div>
                    </div>
                </div>
                <button type="button" onclick="addEmploymentEntry()" style="background-color: #28a745; margin-top: 10px;">Adicionar Emprego</button>
            </div>

            <div class="form-section">
                <h3>7. Histórico de Viagens Internacionais (Últimos 5 anos)</h3>
                <p>Liste todos os países que você visitou nos últimos 5 anos, exceto o seu país de residência atual.</p>
                <div id="travelHistoryContainer">
                    <div class="travel-entry">
                        <div class="form-group">
                            <label>País Visitado:</label>
                            <input type="text" name="countryVisited[]">
                        </div>
                        <div class="form-group">
                            <label>Data de Entrada (MM/AAAA):</label>
                            <input type="month" name="entryDate[]">
                        </div>
                        <div class="form-group">
                            <label>Data de Saída (MM/AAAA):</label>
                            <input type="month" name="exitDate[]">
                        </div>
                        <div class="form-group">
                            <label>Propósito da Viagem:</label>
                            <textarea name="travelPurpose[]" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <button type="button" onclick="addTravelEntry()" style="background-color: #28a745; margin-top: 10px;">Adicionar Viagem</button>
            </div>

            <div class="form-section">
                <h3>8. Perguntas de Elegibilidade e Histórico</h3>
                <div class="form-group radio-group">
                    <label>a. Você já foi condenado(a) por qualquer crime (incluindo DUI/DWI), tem alguma acusação criminal pendente, ou possui mandados de prisão em aberto em qualquer país?</label>
                    <input type="radio" id="crimeYes" name="criminalRecord" value="Sim"> <label for="crimeYes">Sim</label>
                    <input type="radio" id="crimeNo" name="criminalRecord" value="Não" checked> <label for="crimeNo">Não</label>
                    <div class="form-group" id="crimeDetails" style="display: none; margin-top: 10px;">
                        <label for="crimeExplanation">Explique:</label>
                        <textarea id="crimeExplanation" name="crimeExplanation" rows="3"></textarea>
                    </div>
                </div>

                <div class="form-group radio-group">
                    <label>b. Você já foi considerado(a) culpado(a) de violação de quaisquer regulamentos ou leis alfandegárias, de imigração ou agrícolas em qualquer país?</label>
                    <input type="radio" id="violationYes" name="violationRecord" value="Sim"> <label for="violationYes">Sim</label>
                    <input type="radio" id="violationNo" name="violationRecord" value="Não" checked> <label for="violationNo">Não</label>
                    <div class="form-group" id="violationDetails" style="display: none; margin-top: 10px;">
                        <label for="violationExplanation">Explique:</label>
                        <textarea id="violationExplanation" name="violationExplanation" rows="3"></textarea>
                    </div>
                </div>

                <div class="form-group radio-group">
                    <label>c. Você é objeto de uma investigação em andamento por qualquer agência federal, estadual ou local de aplicação da lei?</label>
                    <input type="radio" id="investigationYes" name="investigationStatus" value="Sim"> <label for="investigationYes">Sim</label>
                    <input type="radio" id="investigationNo" name="investigationStatus" value="Não" checked> <label for="investigationNo">Não</label>
                    <div class="form-group" id="investigationDetails" style="display: none; margin-top: 10px;">
                        <label for="investigationExplanation">Explique:</label>
                        <textarea id="investigationExplanation" name="investigationExplanation" rows="3"></textarea>
                    </div>
                </div>

                <div class="form-group radio-group">
                    <label>d. Você já forneceu informações falsas ou incompletas em qualquer formulário de inscrição ou processo de imigração para os Estados Unidos ou qualquer outro país?</label>
                    <input type="radio" id="falseInfoYes" name="falseInformation" value="Sim"> <label for="falseInfoYes">Sim</label>
                    <input type="radio" id="falseInfoNo" name="falseInformation" value="Não" checked> <label for="falseInfoNo">Não</label>
                    <div class="form-group" id="falseInfoDetails" style="display: none; margin-top: 10px;">
                        <label for="falseInfoExplanation">Explique:</label>
                        <textarea id="falseInfoExplanation" name="falseInfoExplanation" rows="3"></textarea>
                    </div>
                </div>
            </div>

            <div class="form-section declaration-section">
                <h3>9. Declaração e Autorização</h3>
                <p>Eu, <input type="text" id="declaracaoNome" name="declaracaoNome" placeholder="Seu Nome Completo">, declaro, sob as penas da lei, que li e compreendi integralmente todas as questões contidas nesta solicitação de visto e afirmo que as respostas por mim fornecidas são verdadeiras, completas e corretas, conforme o meu melhor conhecimento e convicção.</p>

                <p><strong>Declaro estar ciente de que:</strong></p>
                <ol>
                    <li>Qualquer declaração falsa, incompleta ou enganosa poderá resultar na recusa permanente do visto ou na negativa de admissão nos Estados Unidos, conforme disposto na legislação aplicável.</li>
                    <li>Todas as informações prestadas nesta solicitação constituem declarações juramentadas, realizadas sob pena de perjúrio, nos termos do disposto no _28 U.S.C. § 1746_.</li>
                    <li>Informações adicionais poderão ser requisitadas pelas autoridades competentes após a análise desta solicitação, sendo minha responsabilidade fornecê-las tempestivamente.</li>
                    <li>As informações contidas nesta solicitação poderão ser compartilhadas com outras agências governamentais dos Estados Unidos, que possuem autoridade para utilizá-las para fins de aplicação da lei ou para propósitos imigratórios, conforme permitido pela legislação vigente.</li>
                    <li>A fotografia fornecida com esta solicitação poderá ser utilizada pelas autoridades americanas para fins de verificação de identidade, empregabilidade ou outros objetivos legais previstos na legislação dos Estados Unidos.</li>
                </ol>

                <p><strong>Declaro ainda:</strong></p>
                <ol start="6">
                    <li>Que sou exclusivamente responsável pela autenticidade e exatidão dos documentos apresentados e das informações prestadas nesta solicitação.</li>
                    <li>Que tenho pleno conhecimento de que a concessão ou negativa do visto é prerrogativa exclusiva da Autoridade Consular Americana, não cabendo a terceiros qualquer ingerência sobre tal decisão.</li>
                    <li>Que estou ciente de que, em processos de renovação de visto, entrevistas presenciais poderão ser exigidas a critério exclusivo da Autoridade Consular Americana.</li>
                    <li>Que reconheço que o serviço contratado constitui assessoria relacionada ao processo de preenchimento de documentação, agendamento de biometria e entrevista, não abrangendo serviços de entrega ou retirada de documentos no Centro de Atendimento ao Solicitante de Visto (CASV), sendo necessária a contratação de um agente colaborador, caso eu deseje tais serviços adicionais.</li>
                    <li>Que a aposição de minha assinatura eletrônica neste documento possui validade jurídica, conforme a legislação aplicável, e representa meu reconhecimento expresso dos serviços contratados.</li>
                </ol>

                <p>
                    Local: <input type="text" id="declaracaoLocal" name="declaracaoLocal" placeholder="Cidade/Estado">
                    Data: <input type="date" id="declaracaoData" name="declaracaoData">
                </p>

                <label>
                    <input type="checkbox" id="aceitoTermos" name="aceitoTermos">
                    Eu aceito os termos da declaração e autorizo o envio.
                </label>
            </div>

            <div id="loadingMessage" style="display:none; text-align:center; margin-top:20px; color:#0056b3;">
                Processando... Por favor, aguarde.
            </div>
            <button type="submit" id="submitButton">Gerar PDF e Enviar</button>
        </form>
    </div>

    <script type="module">
        // Importações do Firebase (feitas no cabeçalho, apenas para garantir)
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.0.0/firebase-storage.js';

        // Acessa as instâncias globalmente disponíveis
        const storage = window.firebaseStorage;
        const ref = window.firebaseRef;
        const uploadBytes = window.firebaseUploadBytes;
        const getDownloadURL = window.firebaseGetDownloadURL;

        // Funções auxiliares (formatação de data, etc.)
        function formatDateBr(dateStr) {
            if (!dateStr) return 'Não informado';
            try {
                const [year, month, day] = dateStr.split('-');
                const date = new Date(year, month - 1, day);
                return date.toLocaleDateString('pt-BR', { timeZone: 'America/Sao_Paulo' });
            } catch (e) {
                console.error("Erro ao formatar data:", dateStr, e);
                return 'Data inválida';
            }
        }
        
        function formatMonthBr(monthStr) {
            if (!monthStr) return 'Não informado';
            try {
                const [year, month] = monthStr.split('-');
                const date = new Date(year, month - 1, 1);
                return date.toLocaleDateString('pt-BR', { year: 'numeric', month: '2-digit', timeZone: 'America/Sao_Paulo' });
            } catch (e) {
                console.error("Erro ao formatar mês/ano:", monthStr, e);
                return 'Mês/Ano inválido';
            }
        }

        // Funções para toggle de seções (ATUALIZADAS PARA GLOBAL ENTRY IDs)
        function toggleSpouseInfo() {
            const maritalStatus = document.getElementById('maritalStatus');
            const spouseInfo = document.getElementById('spouseInfo');
            const spouseDeathInfo = document.getElementById('spouseDeathInfo');

            if (['Casado', 'Divorciado', 'Viúvo', 'União Estável'].includes(maritalStatus.value)) {
                spouseInfo.classList.remove('hidden-section');
                if (maritalStatus.value === 'Viúvo') {
                    spouseDeathInfo.classList.remove('hidden-section');
                } else {
                    spouseDeathInfo.classList.add('hidden-section');
                    spouseDeathInfo.querySelectorAll('input, textarea, select').forEach(input => input.value = '');
                }
            } else {
                spouseInfo.classList.add('hidden-section');
                spouseDeathInfo.classList.add('hidden-section');
                spouseInfo.querySelectorAll('input, textarea, select').forEach(input => input.value = '');
                spouseDeathInfo.querySelectorAll('input, textarea, select').forEach(input => input.value = '');
            }
        }

        function toggleParentsInfo() {
            const parentsAlive = document.getElementById('parentsAlive');
            const parentsInfo = document.getElementById('parentsInfo');
            
            if (parentsAlive.value === 'Sim') {
                parentsInfo.classList.remove('hidden-section');
                toggleParentsInUSInfo();
            } else {
                parentsInfo.classList.add('hidden-section');
                parentsInfo.querySelectorAll('input, textarea, select').forEach(input => input.value = '');
                document.getElementById('parentsInUSDetails').classList.add('hidden-section');
                document.getElementById('parentsInUSDetails').querySelectorAll('input, textarea, select').forEach(input => input.value = '');
            }
        }

        function toggleParentsInUSInfo() {
            const parentsInUS = document.getElementById('parentsInUS');
            const parentsInUSDetails = document.getElementById('parentsInUSDetails');
            if (parentsInUS.value === 'Sim') {
                parentsInUSDetails.classList.remove('hidden-section');
            } else {
                parentsInUSDetails.classList.add('hidden-section');
                parentsInUSDetails.querySelectorAll('input, textarea, select').forEach(input => input.value = '');
            }
        }

        function toggleKnownInUSInfo() {
            const knownInUS = document.getElementById('knownInUS');
            const knownInUSInfo = document.getElementById('knownInUSInfo');
            if (knownInUS.value === 'Sim') {
                knownInUSInfo.classList.remove('hidden-section');
            } else {
                knownInUSInfo.classList.add('hidden-section');
                knownInUSInfo.querySelectorAll('input, textarea, select').forEach(input => input.value = '');
            }
        }

        function toggleEligibilityDetails(event) {
            const targetId = event.target.id;
            let detailsDivId;

            if (targetId.includes('crime')) {
                detailsDivId = 'crimeDetails';
            } else if (targetId.includes('violation')) {
                detailsDivId = 'violationDetails';
            } else if (targetId.includes('investigation')) {
                detailsDivId = 'investigationDetails';
            } else if (targetId.includes('falseInfo')) {
                detailsDivId = 'falseInfoDetails';
            }

            const detailsDiv = document.getElementById(detailsDivId);
            if (event.target.value === 'Sim') {
                detailsDiv.classList.remove('hidden-section');
            } else {
                detailsDiv.classList.add('hidden-section');
                detailsDiv.querySelectorAll('textarea').forEach(input => input.value = '');
            }
        }

        // Funções para adicionar campos dinâmicos (Endereço, Emprego, Viagem)
        function addAddressEntry() {
            const container = document.getElementById('addressHistoryContainer');
            const newEntry = document.createElement('div');
            newEntry.classList.add('address-entry');
            newEntry.innerHTML = `
                <hr style="margin: 20px 0;">
                <div class="form-group">
                    <label>Endereço:</label>
                    <input type="text" name="pastAddress[]" placeholder="Rua, Número, Complemento">
                </div>
                <div class="form-group">
                    <label>Cidade:</label>
                    <input type="text" name="pastCity[]">
                </div>
                <div class="form-group">
                    <label>Estado/Província:</label>
                    <input type="text" name="pastState[]">
                </div>
                <div class="form-group">
                    <label>País:</label>
                    <input type="text" name="pastCountry[]">
                </div>
                <div class="form-group">
                    <label>De (MM/AAAA):</label>
                    <input type="month" name="pastAddressFrom[]">
                </div>
                <div class="form-group">
                    <label>Até (MM/AAAA):</label>
                    <input type="month" name="pastAddressTo[]">
                </div>
                <button type="button" onclick="this.parentNode.remove()" style="background-color: #dc3545; margin-top: 5px;">Remover Endereço</button>
            `;
            container.appendChild(newEntry);
        }

        function addEmploymentEntry() {
            const container = document.getElementById('employmentHistoryContainer');
            const newEntry = document.createElement('div');
            newEntry.classList.add('employment-entry');
            newEntry.innerHTML = `
                <hr style="margin: 20px 0;">
                <div class="form-group">
                    <label>Empregador:</label>
                    <input type="text" name="employerName[]">
                </div>
                <div class="form-group">
                    <label>Cargo:</label>
                    <input type="text" name="occupation[]">
                </div>
                <div class="form-group">
                    <label>Endereço do Empregador:</label>
                    <input type="text" name="employerAddress[]" placeholder="Rua, Número, Cidade, País">
                </div>
                <div class="form-group">
                    <label>De (MM/AAAA):</label>
                    <input type="month" name="employmentFrom[]">
                </div>
                <div class="form-group">
                    <label>Até (MM/AAAA):</label>
                    <input type="month" name="employmentTo[]">
                </div>
                <button type="button" onclick="this.parentNode.remove()" style="background-color: #dc3545; margin-top: 5px;">Remover Emprego</button>
            `;
            container.appendChild(newEntry);
        }

        function addTravelEntry() {
            const container = document.getElementById('travelHistoryContainer');
            const newEntry = document.createElement('div');
            newEntry.classList.add('travel-entry');
            newEntry.innerHTML = `
                <hr style="margin: 20px 0;">
                <div class="form-group">
                    <label>País Visitado:</label>
                    <input type="text" name="countryVisited[]">
                </div>
                <div class="form-group">
                    <label>Data de Entrada (MM/AAAA):</label>
                    <input type="month" name="entryDate[]">
                </div>
                <div class="form-group">
                    <label>Data de Saída (MM/AAAA):</label>
                    <input type="month" name="exitDate[]">
                </div>
                <div class="form-group">
                    <label>Propósito da Viagem:</label>
                    <textarea name="travelPurpose[]" rows="2"></textarea>
                </div>
                <button type="button" onclick="this.parentNode.remove()" style="background-color: #dc3545; margin-top: 5px;">Remover Viagem</button>
            `;
            container.appendChild(newEntry);
        }


        // Adicionando event listeners para as toggles e o submit
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('maritalStatus').addEventListener('change', toggleSpouseInfo);
            document.getElementById('parentsAlive').addEventListener('change', toggleParentsInfo);
            document.getElementById('parentsInUS').addEventListener('change', toggleParentsInUSInfo);
            document.getElementById('knownInUS').addEventListener('change', toggleKnownInUSInfo);

            document.getElementById('crimeYes').addEventListener('change', toggleEligibilityDetails);
            document.getElementById('crimeNo').addEventListener('change', toggleEligibilityDetails);
            document.getElementById('violationYes').addEventListener('change', toggleEligibilityDetails);
            document.getElementById('violationNo').addEventListener('change', toggleEligibilityDetails);
            document.getElementById('investigationYes').addEventListener('change', toggleEligibilityDetails);
            document.getElementById('investigationNo').addEventListener('change', toggleEligibilityDetails);
            document.getElementById('falseInfoYes').addEventListener('change', toggleEligibilityDetails);
            document.getElementById('falseInfoNo').addEventListener('change', toggleEligibilityDetails);

            const form = document.getElementById('globalEntryForm');
            form.addEventListener('submit', generatePDF);

            // Chamadas iniciais para definir o estado correto no carregamento da página
            toggleSpouseInfo();
            toggleParentsInfo();
            toggleKnownInUSInfo();
            // As de elegibilidade serão controladas pelo estado 'checked' inicial no HTML ('Não' por padrão)
        });

        // Função para gerar o PDF e enviar
        async function generatePDF(event) {
            event.preventDefault(); // Previne o envio padrão do formulário e o reset da página
            const submitButton = document.getElementById('submitButton');
            const loadingMessage = document.getElementById('loadingMessage');
            submitButton.disabled = true;
            loadingMessage.style.display = 'block';

            try {
                const { jsPDF } = window.jspdf; // Acessa jsPDF via window
                const form = document.getElementById('globalEntryForm');
                const formData = new FormData(form);
                
                // Nome do solicitante para o nome do arquivo e mensagem do WhatsApp
                const solicitanteNome = formData.get('fullName') || formData.get('declaracaoNome') || 'sem_nome';
                const solicitantePassaporte = formData.get('passportNumber') || 'Não informado';
                const fixedWhatsAppNumber = '5561999998165'; // Seu número de WhatsApp fixo


                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.width;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 10;
                let yPosition = 30;

                function drawHeader() {
                    doc.setFillColor(0, 48, 135); /* Azul Marinho */
                    doc.rect(0, 0, pageWidth, 25, 'F');
                    doc.setFontSize(16);
                    doc.setTextColor(255, 255, 255); /* Branco */
                    doc.setFont("Helvetica", "bold");
                    const title = "Formulário de Solicitação Global Entry"; // Título alterado para Global Entry
                    const titleWidth = doc.getTextWidth(title);
                    const titleX = (pageWidth - titleWidth) / 2;
                    doc.text(title, titleX, 15);
                    doc.setFontSize(14);
                    const starSpacing = 8;
                    for (let i = 0; i < 3; i++) {
                        doc.text("*", titleX - (i + 1) * starSpacing - 5, 15);
                        doc.text("*", titleX + titleWidth + (i + 1) * starSpacing + 5, 15);
                    }
                }

                function drawPageBorder() {
                    doc.setDrawColor(0, 48, 135); /* Azul Marinho */
                    doc.setLineWidth(0.5);
                    doc.rect(margin / 2, margin / 2, pageWidth - margin, pageHeight - margin);
                }

                function addSectionTitle(title) {
                    if (yPosition + 15 > pageHeight - margin) {
                        doc.addPage();
                        yPosition = 30;
                        drawHeader();
                        drawPageBorder();
                    }
                    doc.setFillColor(200, 16, 46); /* Vermelho */
                    doc.rect(margin, yPosition - 5, pageWidth - 2 * margin, 10, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(255, 255, 255); /* Branco */
                    doc.setFont("Helvetica", "bold");
                    doc.text(title, margin + 5, yPosition + 2);
                    yPosition += 15;
                }

                function addText(label, value, isBoldLabel = false, isBoldValue = false) {
                    const maxWidth = pageWidth - 2 * margin;
                    const lineHeight = 7;
                    
                    doc.setFont("Helvetica", isBoldLabel ? "bold" : "normal");
                    doc.setTextColor(0, 0, 0); // Black
                    doc.setFontSize(10);
                    
                    const labelText = label + (label ? ": " : "");
                    const labelWidth = doc.getTextWidth(labelText);

                    let currentText = labelText;

                    doc.setFont("Helvetica", isBoldValue ? "bold" : "normal");
                    const valueText = value || 'Não informado';
                    currentText += valueText;

                    const lines = doc.splitTextToSize(currentText, maxWidth);

                    for (let i = 0; i < lines.length; i++) {
                        if (yPosition + lineHeight > pageHeight - margin) {
                            doc.addPage();
                            yPosition = 30;
                            drawHeader();
                            drawPageBorder();
                        }
                        doc.text(lines[i], margin, yPosition);
                        yPosition += lineHeight;
                    }
                    yPosition += 2; // Extra spacing after each entry
                }

                function addJustifiedText(text) {
                    const maxWidth = pageWidth - 2 * margin;
                    const lineHeight = 7;
                    doc.setFont("Helvetica", "normal");
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(10);

                    const parts = text.split(/(\*\*.*?\*\*|_.*?_)/g);
                    let currentX = margin;
                    let lineBuffer = []; 

                    for (let i = 0; i < parts.length; i++) {
                        let part = parts[i];
                        let fontStyle = "normal";

                        if (part.startsWith('**') && part.endsWith('**')) {
                            fontStyle = "bold";
                            part = part.substring(2, part.length - 2);
                        } else if (part.startsWith('_') && part.endsWith('_')) {
                            fontStyle = "italic";
                            part = part.substring(1, part.length - 1);
                        }
                        
                        const words = part.trim().split(/\s+/);
                        for (let j = 0; j < words.length; j++) {
                            const word = words[j];
                            const wordWithSpace = word + (j < words.length - 1 ? ' ' : '');

                            doc.setFont("Helvetica", fontStyle);
                            const wordWidth = doc.getTextWidth(wordWithSpace);

                            // Check if adding the current word overflows the current line
                            // We need to simulate how the text would be rendered if it's all on one line
                            let tempLineForWidthCalculation = "";
                            lineBuffer.forEach(item => tempLineForWidthCalculation += item.text);
                            tempLineForWidthCalculation += wordWithSpace;

                            if (doc.getTextWidth(tempLineForWidthCalculation) > maxWidth) {
                                // Flush the current line buffer
                                let currentLineStartX = margin;
                                for (let k = 0; k < lineBuffer.length; k++) {
                                    doc.setFont("Helvetica", lineBuffer[k].style);
                                    doc.text(lineBuffer[k].text, currentLineStartX, yPosition);
                                    currentLineStartX += doc.getTextWidth(lineBuffer[k].text);
                                }
                                yPosition += lineHeight;
                                currentX = margin; // Reset X for new line
                                lineBuffer = []; // Clear buffer

                                // Check for page break BEFORE adding the new word to a new line
                                if (yPosition + lineHeight > pageHeight - margin) {
                                    doc.addPage();
                                    yPosition = 30;
                                    drawHeader();
                                    drawPageBorder();
                                    currentX = margin;
                                }
                            }
                            lineBuffer.push({ text: wordWithSpace, style: fontStyle });
                        }
                    }
                    // Flush any remaining text in the buffer
                    if (lineBuffer.length > 0) {
                        let currentLineStartX = margin;
                        for (let k = 0; k < lineBuffer.length; k++) {
                            doc.setFont("Helvetica", lineBuffer[k].style);
                            doc.text(lineBuffer[k].text, currentLineStartX, yPosition);
                            currentLineStartX += doc.getTextWidth(lineBuffer[k].text);
                        }
                        yPosition += lineHeight;
                    }
                    yPosition += 2; // Extra spacing after each entry
                }


                drawHeader();
                drawPageBorder();

                // 1. Dados Pessoais
                addSectionTitle("1. Dados Pessoais");
                addText(`Nome Completo`, formData.get('fullName'));
                addText(`Data de Nascimento`, formatDateBr(formData.get('dob')));
                addText(`Gênero`, formData.get('gender'));
                addText(`Nacionalidade Atual`, formData.get('nationality'));
                addText(`Outras Nacionalidades`, formData.get('otherNationalities'));
                addText(`País de Nascimento`, formData.get('countryOfBirth'));
                addText(`Cidade de Nascimento`, formData.get('cityOfBirth'));
                addText(`Estado Civil`, formData.get('maritalStatus'));

                const maritalStatus = formData.get('maritalStatus');
                if (['Casado', 'Divorciado', 'Viúvo', 'União Estável'].includes(maritalStatus)) {
                    addSectionTitle("Dados do Cônjuge");
                    addText(`Nome Completo do Cônjuge`, formData.get('spouseFullName'));
                    addText(`Data de Nascimento do Cônjuge`, formatDateBr(formData.get('spouseDob')));
                    addText(`País de Nascimento do Cônjuge`, formData.get('spouseCountryOfBirth'));
                    if (maritalStatus === 'Viúvo') {
                        addText(`Data de Falecimento do Cônjuge`, formatDateBr(formData.get('spouseDod')));
                    }
                }

                // 2. Dados do Passaporte
                addSectionTitle("2. Dados do Passaporte");
                addText(`Número do Passaporte`, formData.get('passportNumber'));
                addText(`Data de Emissão`, formatDateBr(formData.get('issueDate')));
                addText(`Data de Validade`, formatDateBr(formData.get('expiryDate')));
                addText(`País Emissor`, formData.get('issuingCountry'));

                // 3. Endereço Atual e Contato
                addSectionTitle("3. Endereço Atual e Contato");
                addText(`Endereço`, formData.get('currentAddress'));
                addText(`Cidade`, formData.get('currentCity'));
                addText(`Estado/Província`, formData.get('currentState'));
                addText(`CEP/Código Postal`, formData.get('currentZipCode'));
                addText(`País`, formData.get('currentCountry'));
                addText(`Telefone`, formData.get('phone'));
                addText(`E-mail`, formData.get('email'));

                // 4. Informações Familiares
                addSectionTitle("4. Informações Familiares");
                addText(`Seus pais estão vivos?`, formData.get('parentsAlive'));
                if (formData.get('parentsAlive') === 'Sim') {
                    addText(`Nome Completo do Pai`, formData.get('fatherFullName'));
                    addText(`Data de Nascimento do Pai`, formatDateBr(formData.get('fatherDob')));
                    addText(`Nome Completo da Mãe`, formData.get('motherFullName'));
                    addText(`Data de Nascimento da Mãe`, formatDateBr(formData.get('motherDob')));
                    addText(`Seus pais estão nos EUA?`, formData.get('parentsInUS'));
                    if (formData.get('parentsInUS') === 'Sim') {
                        addText(`Explicação sobre pais nos EUA`, formData.get('parentsInUSExplanation'));
                    }
                }
                addText(`Você tem conhecidos nos EUA?`, formData.get('knownInUS'));
                if (formData.get('knownInUS') === 'Sim') {
                    addSectionTitle("Dados do Conhecido nos EUA");
                    addText(`Nome Completo do Conhecido`, formData.get('knownName'));
                    addText(`Telefone do Conhecido`, formData.get('knownPhone'));
                    addText(`E-mail do Conhecido`, formData.get('knownEmail'));
                    addText(`Vínculo com o Solicitante`, formData.get('knownRelationship'));
                }

                // 5. Histórico de Endereços
                addSectionTitle("5. Histórico de Endereços (Últimos 5 anos)");
                const pastAddresses = form.querySelectorAll('#addressHistoryContainer .address-entry');
                if (pastAddresses.length > 0 && pastAddresses[0].querySelector('[name="pastAddress[]"]').value) {
                    pastAddresses.forEach((entry, index) => {
                        const address = entry.querySelector('[name="pastAddress[]"]').value;
                        const city = entry.querySelector('[name="pastCity[]"]').value;
                        const state = entry.querySelector('[name="pastState[]"]').value;
                        const country = entry.querySelector('[name="pastCountry[]"]').value;
                        const from = formatMonthBr(entry.querySelector('[name="pastAddressFrom[]"]').value);
                        const to = formatMonthBr(entry.querySelector('[name="pastAddressTo[]"]').value);
                        addText(`Endereço ${index + 1}`, `${address}, ${city}, ${state}, ${country}. De: ${from} Até: ${to}`);
                    });
                } else {
                    addText('', 'Nenhum endereço adicional informado.');
                }

                // 6. Histórico de Emprego
                addSectionTitle("6. Histórico de Emprego (Últimos 5 anos)");
                const employments = form.querySelectorAll('#employmentHistoryContainer .employment-entry');
                if (employments.length > 0 && employments[0].querySelector('[name="employerName[]"]').value) {
                    employments.forEach((entry, index) => {
                        const employerName = entry.querySelector('[name="employerName[]"]').value;
                        const occupation = entry.querySelector('[name="occupation[]"]').value;
                        const employerAddress = entry.querySelector('[name="employerAddress[]"]').value;
                        const from = formatMonthBr(entry.querySelector('[name="employmentFrom[]"]').value);
                        const to = formatMonthBr(entry.querySelector('[name="employmentTo[]"]').value);
                        addText(`Emprego ${index + 1}`, `Empregador: ${employerName}, Cargo: ${occupation}, Endereço: ${employerAddress}. De: ${from} Até: ${to}`);
                    });
                } else {
                    addText('', 'Nenhum histórico de emprego informado.');
                }
                
                // 7. Histórico de Viagens Internacionais
                addSectionTitle("7. Histórico de Viagens Internacionais (Últimos 5 anos)");
                const travels = form.querySelectorAll('#travelHistoryContainer .travel-entry');
                if (travels.length > 0 && travels[0].querySelector('[name="countryVisited[]"]').value) {
                    travels.forEach((entry, index) => {
                        const countryVisited = entry.querySelector('[name="countryVisited[]"]').value;
                        const entryDate = formatMonthBr(entry.querySelector('[name="entryDate[]"]').value);
                        const exitDate = formatMonthBr(entry.querySelector('[name="exitDate[]"]').value);
                        const travelPurpose = entry.querySelector('[name="travelPurpose[]"]').value;
                        addText(`Viagem ${index + 1}`, `País: ${countryVisited}, Entrada: ${entryDate}, Saída: ${exitDate}, Propósito: ${travelPurpose}`);
                    });
                } else {
                    addText('', 'Nenhum histórico de viagem internacional informado.');
                }

                // 8. Perguntas de Elegibilidade e Histórico
                addSectionTitle("8. Perguntas de Elegibilidade e Histórico");
                addText(`a. Condenado por crime/acusação pendente/mandados:`, formData.get('criminalRecord'));
                if (formData.get('criminalRecord') === 'Sim') {
                    addText(`Explicação`, formData.get('crimeExplanation'));
                }
                addText(`b. Violação de regulamentos/leis (alfandegárias, imigração, agrícolas):`, formData.get('violationRecord'));
                if (formData.get('violationRecord') === 'Sim') {
                    addText(`Explicação`, formData.get('violationExplanation'));
                }
                addText(`c. Objeto de investigação em andamento:`, formData.get('investigationStatus'));
                if (formData.get('investigationStatus') === 'Sim') {
                    addText(`Explicação`, formData.get('investigationExplanation'));
                }
                addText(`d. Forneceu informações falsas/incompletas (formulário/processo imigração):`, formData.get('falseInformation'));
                if (formData.get('falseInformation') === 'Sim') {
                    addText(`Explicação`, formData.get('falseInfoExplanation'));
                }

                // 9. Declaração e Autorização
                addSectionTitle("9. Declaração e Autorização");
                addJustifiedText(`Eu, **${formData.get('declaracaoNome') || 'Não informado'}**, declaro, sob as penas da lei, que li e compreendi integralmente todas as questões contidas nesta solicitação de visto e afirmo que as respostas por mim fornecidas são verdadeiras, completas e corretas, conforme o meu melhor conhecimento e convicção.`);
                yPosition += 5;
                addJustifiedText(`**Declaro estar ciente de que:**`);
                addJustifiedText(`1. Qualquer declaração falsa, incompleta ou enganosa poderá resultar na recusa permanente do visto ou na negativa de admissão nos Estados Unidos, conforme disposto na legislação aplicável.`);
                addJustifiedText(`2. Todas as informações prestadas nesta solicitação constituem declarações juramentadas, realizadas sob pena de perjúrio, nos termos do disposto no _28 U.S.C. § 1746_.`);
                addJustifiedText(`3. Informações adicionais poderão ser requisitadas pelas autoridades competentes após a análise desta solicitação, sendo minha responsabilidade fornecê-las tempestivamente.`);
                addJustifiedText(`4. As informações contidas nesta solicitação poderão ser compartilhadas com outras agências governamentais dos Estados Unidos, que possuem autoridade para utilizá-las para fins de aplicação da lei ou para propósitos imigratórios, conforme permitido pela legislação vigente.`);
                addJustifiedText(`5. A fotografia fornecida com esta solicitação poderá ser utilizada pelas autoridades americanas para fins de verificação de identidade, empregabilidade ou outros objetivos legais previstos na legislação dos Estados Unidos.`);
                yPosition += 5;
                addJustifiedText(`**Declaro ainda:**`);
                addJustifiedText(`6. Que sou exclusivamente responsável pela autenticidade e exatidão dos documentos apresentados e das informações prestadas nesta solicitação.`);
                addJustifiedText(`7. Que tenho pleno conhecimento de que a concessão ou negativa do visto é prerrogativa exclusiva da Autoridade Consular Americana, não cabendo a terceiros qualquer ingerência sobre tal decisão.`);
                addJustifiedText(`8. Que estou ciente de que, em processos de renovação de visto, entrevistas presenciais poderão ser exigidas a critério exclusivo da Autoridade Consular Americana.`);
                addJustifiedText(`9. Que reconheço que o serviço contratado constitui assessoria relacionada ao processo de preenchimento de documentação, agendamento de biometria e entrevista, não abrangendo serviços de entrega ou retirada de documentos no Centro de Atendimento ao Solicitante de Visto (CASV), sendo necessária a contratação de um agente colaborador, caso eu deseje tais serviços adicionais.`);
                addJustifiedText(`10. Que a aposição de minha assinatura eletrônica neste documento possui validade jurídica, conforme a legislação aplicável, e representa meu reconhecimento expresso dos serviços contratados.`);
                yPosition += 5;
                addText(`Local`, formData.get('declaracaoLocal'));
                addText(`Data`, formatDateBr(formData.get('declaracaoData')));
                addText(`Aceito os termos da declaração e autorizo o envio`, formData.get('aceitoTermos') === 'on' ? 'Sim' : 'Não');


                // Mantendo o nome de arquivo e estrutura de pasta do DS-160
                doc.save('formulario_visto.pdf'); // Salva com o nome 'formulario_visto.pdf' no navegador

                const pdfBlob = doc.output('blob');
                const timestamp = Date.now();
                // O nome do arquivo no Firebase Storage será o mesmo padrão do DS-160
                const firebaseFileName = `pdfs/formulario_visto_${solicitanteNome.replace(/\s+/g, '_')}_${timestamp}.pdf`;
                const storageRef = ref(storage, firebaseFileName);

                await uploadBytes(storageRef, pdfBlob);
                const downloadUrl = await getDownloadURL(storageRef);
                
                console.log('PDF uploaded successfully:', downloadUrl);

                // Mensagem do WhatsApp com o mesmo formato do DS-160
                const whatsappMessage = `Formulário de Visto Americano preenchido por ${solicitanteNome}.\\nPassaporte: ${solicitantePassaporte}\\nClique no link para visualizar e baixar o PDF: ${downloadUrl}`;
                const whatsappUrl = `https://api.whatsapp.com/send?phone=${fixedWhatsAppNumber}&text=${encodeURIComponent(whatsappMessage)}`;
                window.open(whatsappUrl, '_blank');

                alert('Formulário enviado com sucesso! O PDF foi baixado e uma mensagem com o link foi enviada ao WhatsApp.');

            } catch (error) {
                console.error('Erro ao gerar PDF ou enviar para o WhatsApp:', error);
                alert('Erro ao processar o formulário. Verifique o console para mais detalhes.');
            } finally {
                submitButton.disabled = false;
                loadingMessage.style.display = 'none';
            }
        }
    </script>
</body>
</html>
